<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipping Fraud Detection - Setup</title>
    <link rel="icon" type="image/x-icon" href="../../SFD.ico">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="../SFDLoad.png" alt="SFD Logo" style="width: 80px; height: 80px; margin-bottom: 15px; display: block; margin-left: auto; margin-right: auto;">
            <h1>üîç‚öì Shipping Fraud Detection System</h1>
            <p>Maritime Intelligence & Analysis Platform - Configuration</p>
        </div>
        
        <div class="warning-box">
            <h3>‚ö†Ô∏è Test Implementation - Limited Data Range</h3>
            <p>This is a test implementation. The system can only analyze AIS data from <strong>October 15, 2024</strong> through <strong>March 30, 2025</strong>. Queries outside this date range will not return results.</p>
        </div>
        
        <div class="info-box">
            <p><strong>üìä Supported Data Formats:</strong> CSV (.csv) and Parquet (.parquet) files containing AIS data with standard fields (MMSI, LAT, LON, BaseDateTime, SOG, COG, Heading, etc.)</p>
        </div>
        
        <div class="data-source-selector">
            <h3 style="margin-bottom: 15px;">Select Data Source</h3>
            <div class="radio-group">
                <div class="radio-option" id="aws-option">
                    <label>
                        <input type="radio" name="dataSource" value="aws" checked>
                        <strong>‚òÅÔ∏è AWS S3 Bucket</strong>
                        <p style="margin-top: 5px; font-size: 13px; color: #666;">Connect to cloud-stored AIS data</p>
                    </label>
                </div>
                <div class="radio-option" id="local-option">
                    <label>
                        <input type="radio" name="dataSource" value="local">
                        <strong>üíæ Local Folder</strong>
                        <p style="margin-top: 5px; font-size: 13px; color: #666;">Use data from your computer</p>
                    </label>
                </div>
                <div class="radio-option" id="noaa-option">
                    <label>
                        <input type="radio" name="dataSource" value="noaa">
                        <strong>üåä NOAA (Download on-demand)</strong>
                        <p style="margin-top: 5px; font-size: 13px; color: #666;">Automatically download AIS data from NOAA as needed</p>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- AWS S3 Configuration -->
        <div id="aws-config" class="config-section active">
            <h3 style="margin-bottom: 15px;">AWS S3 Configuration</h3>
            
            <div class="form-group">
                <label>S3 Bucket Name *</label>
                <input type="text" id="s3-bucket" placeholder="e.g., my-ais-data-bucket" required>
                <small>The name of your S3 bucket containing AIS data</small>
            </div>
            
            <div class="form-group">
                <label>S3 Prefix (Path)</label>
                <input type="text" id="s3-prefix" placeholder="e.g., ais-data/parquet/" value="">
                <small>Optional: Folder path within the bucket (leave empty for root)</small>
            </div>
            
            <div class="form-group">
                <label>AWS Region *</label>
                <select id="s3-region">
                    <option value="us-east-1">US East (N. Virginia)</option>
                    <option value="us-east-2">US East (Ohio)</option>
                    <option value="us-west-1">US West (N. California)</option>
                    <option value="us-west-2">US West (Oregon)</option>
                    <option value="eu-west-1">EU (Ireland)</option>
                    <option value="eu-central-1">EU (Frankfurt)</option>
                    <option value="ap-southeast-1">Asia Pacific (Singapore)</option>
                    <option value="ap-southeast-2">Asia Pacific (Sydney)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Authentication Method *</label>
                <select id="auth-method">
                    <option value="credentials">Access Key & Secret</option>
                    <option value="profile">AWS Profile</option>
                    <option value="iam">IAM Role (EC2/Lambda)</option>
                </select>
            </div>
            
            <div id="credentials-section">
                <div class="form-group">
                    <label>AWS Access Key ID</label>
                    <input type="text" id="access-key" placeholder="AKIA...">
                </div>
                
                <div class="form-group">
                    <label>AWS Secret Access Key</label>
                    <input type="password" id="secret-key" placeholder="Enter secret key">
                </div>
                
                <div class="form-group">
                    <label>Session Token (Optional)</label>
                    <input type="password" id="session-token" placeholder="For temporary credentials">
                </div>
            </div>
            
            <div id="profile-section" style="display: none;">
                <div class="form-group">
                    <label>AWS Profile Name</label>
                    <input type="text" id="profile-name" placeholder="default">
                    <small>Profile name from ~/.aws/credentials</small>
                </div>
            </div>
        </div>
        
        <!-- Local Folder Configuration -->
        <div id="local-config" class="config-section">
            <h3 style="margin-bottom: 15px;">Local Data Configuration</h3>
            
            <div class="form-group">
                <label>Data Folder Path *</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="local-path" placeholder="C:\AIS_Data or /home/user/ais_data" style="flex: 1;">
                    <button type="button" class="btn btn-secondary" onclick="browseLocalFolder()" style="flex: 0 0 auto; padding: 12px 20px;">
                        üìÅ Browse...
                    </button>
                </div>
                <small>Folder containing your CSV or Parquet files organized by date</small>
            </div>
            
            <div class="form-group">
                <label>File Format</label>
                <select id="file-format">
                    <option value="auto">Auto-detect</option>
                    <option value="parquet">Parquet (.parquet)</option>
                    <option value="csv">CSV (.csv)</option>
                </select>
            </div>
            
            <div class="info-box" style="margin-top: 15px;">
                <p><strong>Expected Folder Structure:</strong><br>
                YourFolder/<br>
                ‚îú‚îÄ‚îÄ 2024-10-15.parquet (or .csv)<br>
                ‚îú‚îÄ‚îÄ 2024-10-16.parquet<br>
                ‚îú‚îÄ‚îÄ 2024-10-17.parquet<br>
                ‚îî‚îÄ‚îÄ ... (more date files)</p>
            </div>
        </div>
        
        <!-- Claude API Configuration -->
        <!-- User Personalization -->
        <div class="form-group" style="margin-top: 30px;">
            <h3 style="margin-bottom: 15px;">üë§ Personalization</h3>
            <label>Your Name <span style="color: #999;">(optional)</span></label>
            <input type="text" id="user-name" placeholder="e.g., John, Sarah, Detective Smith">
            <small>Used for personalized greetings like "Welcome back, John!" This is stored locally on your computer.</small>
        </div>
        
        <!-- Claude API Key Configuration -->
        <div class="form-group" style="margin-top: 30px;">
            <h3 style="margin-bottom: 15px;">üîë Claude API Configuration</h3>
            <label>Anthropic API Key *</label>
            <input type="password" id="claude-api-key" placeholder="sk-ant-...">
            <small>Get your API key from <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a></small>
        </div>
        
        <!-- Output Folder Configuration -->
        <div class="form-group" style="margin-top: 30px;">
            <h3 style="margin-bottom: 15px;">üìÅ Output Folder Configuration</h3>
            <label>Where to save generated files (maps, charts, reports) <span style="color: #999;">(optional)</span></label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="output-folder" placeholder="Leave blank for default: Downloads/AISDS_Output" style="flex: 1;">
                <button type="button" class="btn btn-secondary" onclick="browseOutputFolder()" style="flex: 0 0 auto; padding: 12px 20px;">
                    üìÅ Browse...
                </button>
            </div>
            <small>
                <strong>üí° Default Location:</strong> If left blank, files will be saved to <strong>AISDS_Output</strong> folder in your Downloads directory.<br><br>
                <strong>What gets saved:</strong><br>
                ‚Ä¢ Interactive maps (.html)<br>
                ‚Ä¢ Charts and graphs (.png, .html)<br>
                ‚Ä¢ Data exports (.csv, .xlsx)<br>
                ‚Ä¢ Analysis reports<br><br>
                The folder will be created automatically if it doesn't exist.
            </small>
        </div>
        
        <!-- GPU Status Display -->
        <div class="info-box" id="gpu-status" style="margin-top: 20px; display: none;">
            <h3 style="margin-bottom: 10px;">üéÆ GPU Status</h3>
            <div id="gpu-info"></div>
        </div>
        
        <div class="button-group">
            <button class="btn btn-secondary" onclick="testSettings()">üîç Test Settings</button>
            <button class="btn btn-primary" onclick="saveAndContinue()">üíæ Save & Continue</button>
            <button class="btn btn-danger" onclick="closeApplication()">‚ùå Close Application</button>
        </div>
        
        <div id="status-message" class="status-message"></div>
    </div>
    
    <!-- Close Application Modal -->
    <div id="close-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üö™ Close Application</h2>
            </div>
            <div class="modal-body">
                <p style="color: #555; line-height: 1.6; margin-bottom: 20px;">
                    Are you sure you want to exit? Any unsaved configuration will be lost.
                </p>
                <p style="color: #856404; background: #fff3cd; padding: 15px; border-radius: 5px; font-size: 14px;">
                    <strong>Note:</strong> For security reasons, browsers may not allow automatic tab closing. 
                    If the tab doesn't close automatically, use the keyboard shortcut below.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="confirmClose()">Yes, Close Application</button>
                <button class="btn btn-secondary" onclick="cancelClose()">Cancel</button>
            </div>
        </div>
    </div>
    
    <script src="js/setup.js"></script>
    <script>
        /**
         * Show close confirmation modal
         */
        function closeApplication() {
            document.getElementById('close-modal').style.display = 'flex';
        }
        
        /**
         * Cancel close action
         */
        function cancelClose() {
            document.getElementById('close-modal').style.display = 'none';
        }
        
        /**
         * Confirm and attempt to close the application
         */
        function confirmClose() {
            // Try to close the window
            // Multiple methods for better browser compatibility
            
            // Method 1: Try to make window "closeable" by opening about:blank to self
            try {
                window.open('', '_self', '');
                window.close();
            } catch (e) {
                // If that fails, try direct close
                window.close();
            }
            
            // If window.close() doesn't work (most modern browsers block this),
            // show instructions
            setTimeout(() => {
                if (!window.closed) {
                    const modal = document.getElementById('close-modal');
                    const modalBody = modal.querySelector('.modal-body');
                    const modalFooter = modal.querySelector('.modal-footer');
                    
                    modalBody.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <h3 style="color: #333; margin-bottom: 20px;">üö™ To Close This Application</h3>
                            <p style="color: #666; line-height: 1.8; font-size: 16px;">
                                For security reasons, browsers don't allow websites to close tabs automatically.
                            </p>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: left;">
                                <p style="color: #555; margin: 10px 0;">
                                    <strong>Windows:</strong> Press <kbd style="background: #fff; padding: 5px 10px; border: 1px solid #ccc; border-radius: 3px; font-family: monospace;">Ctrl + W</kbd>
                                </p>
                                <p style="color: #555; margin: 10px 0;">
                                    <strong>Mac:</strong> Press <kbd style="background: #fff; padding: 5px 10px; border: 1px solid #ccc; border-radius: 3px; font-family: monospace;">‚åò + W</kbd>
                                </p>
                                <p style="color: #555; margin: 10px 0;">
                                    <strong>Alternative:</strong> Click the <strong>[X]</strong> button on your browser tab
                                </p>
                            </div>
                        </div>
                    `;
                    
                    modalFooter.innerHTML = `
                        <button class="btn btn-primary" onclick="location.reload()">Go Back to Setup</button>
                    `;
                }
            }, 100);
        }
    </script>
</body>
</html>


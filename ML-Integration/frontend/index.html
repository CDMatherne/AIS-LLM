<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipping Fraud Detection System</title>
    <link rel="icon" type="image/x-icon" href="../backend/SFD.ico">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #6BB6E7 0%, #5FA8DB 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 20px;
        }
        
        .header-info {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
        }
        
        .map-panel {
            flex: 1;
            background: #f5f5f5;
            border-right: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            position: relative;
        }
        
        .map-panel iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .map-placeholder {
            text-align: center;
        }
        
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            max-width: 80%;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            background: #e3f2fd;
            margin-left: auto;
        }
        
        .message.assistant {
            background: #f5f5f5;
            margin-right: auto;
        }
        
        /* Popup Modal Styles */
        .popup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s;
        }
        
        .popup-content {
            background: white;
            border-radius: 15px;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s ease-out;
        }
        
        .popup-header {
            background: linear-gradient(135deg, #6BB6E7 0%, #5FA8DB 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 15px 15px 0 0;
            text-align: center;
        }
        
        .popup-header h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .popup-header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .popup-body {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input[type="date"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .checkbox-label {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .checkbox-label:hover {
            border-color: #6BB6E7;
            background: #f0f9ff;
        }
        
        .checkbox-label input[type="checkbox"] {
            margin-top: 4px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .checkbox-text {
            flex: 1;
        }
        
        .checkbox-text strong {
            display: block;
            color: #333;
            margin-bottom: 4px;
            font-size: 16px;
        }
        
        .checkbox-text small {
            display: block;
            color: #666;
            font-size: 13px;
            line-height: 1.4;
        }
        
        /* Vessel Type Category Styles */
        .vessel-category {
            margin-bottom: 20px;
        }
        
        .category-header {
            font-size: 16px;
            font-weight: 700;
            color: #2c5282;
            background: #e6f2ff;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #6BB6E7;
        }
        
        .category-types {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-left: 10px;
        }
        
        .vessel-type-option {
            margin-left: 10px;
        }
        
        .vessel-type-popup .popup-content {
            max-width: 800px;
        }
        
        .vessel-type-popup .popup-body.scrollable {
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .vessel-type-popup .instructions {
            font-size: 13px;
            opacity: 0.85;
            margin-top: 8px;
        }
        
        .popup-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #6BB6E7 0%, #5FA8DB 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(107, 182, 231, 0.4);
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #666;
            border: 2px solid #ddd;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
            border-color: #bbb;
        }
        
        .message-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .message-content {
            color: #555;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .input-area {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            background: #fafafa;
        }
        
        .input-container {
            display: flex;
            gap: 10px;
        }
        
        .input-container input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
        }
        
        .input-container input:focus {
            outline: none;
            border-color: #6BB6E7;
        }
        
        .input-container button {
            padding: 12px 30px;
            background: #6BB6E7;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .input-container button:hover {
            background: #5FA8DB;
        }
        
        .input-container button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .tip {
            font-size: 11px;
            color: #888;
            margin-top: 8px;
        }
        
        .loading {
            text-align: center;
            color: #888;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #6BB6E7;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
        }
        
        /* Welcome Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.3s;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 650px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s ease-out;
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #6BB6E7 0%, #5FA8DB 100%);
            color: white;
            padding: 30px;
            border-radius: 15px 15px 0 0;
            text-align: center;
        }
        
        .modal-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .modal-header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .welcome-section {
            margin-bottom: 25px;
        }
        
        .welcome-section h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .welcome-section ul {
            list-style: none;
            padding: 0;
        }
        
        .welcome-section li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            color: #555;
            line-height: 1.6;
        }
        
        .welcome-section li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #4CAF50;
            font-weight: bold;
        }
        
        .requirements-box {
            background: #f0f9ff;
            border-left: 4px solid #6BB6E7;
            padding: 15px 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .requirements-box h3 {
            color: #1E5C7A;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .requirements-box ul {
            list-style: none;
            padding: 0;
        }
        
        .requirements-box li {
            padding: 5px 0;
            padding-left: 25px;
            position: relative;
            color: #555;
        }
        
        .requirements-box li:before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: #6BB6E7;
            font-weight: bold;
        }
        
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .warning-box strong {
            color: #856404;
            display: block;
            margin-bottom: 5px;
        }
        
        .warning-box p {
            color: #856404;
            margin: 0;
            font-size: 14px;
        }
        
        .modal-footer {
            padding: 20px 30px 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .modal-btn {
            padding: 15px 40px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 180px;
        }
        
        .modal-btn-primary {
            background: linear-gradient(135deg, #6BB6E7 0%, #5FA8DB 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(107, 182, 231, 0.4);
        }
        
        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(107, 182, 231, 0.5);
        }
        
        .modal-btn-secondary {
            background: #f5f5f5;
            color: #666;
            border: 2px solid #ddd;
        }
        
        .modal-btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .hidden {
            display: none;
        }
        
        /* Manual Analysis Modal - Side Panel from Left */
        #manual-analysis-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: none;
            align-items: stretch;
            justify-content: flex-start;
            animation: fadeInOverlay 0.3s;
        }
        
        #manual-analysis-modal .modal-content {
            background: white;
            width: 500px;
            max-width: 90vw;
            height: 100%;
            max-height: 100vh;
            overflow-y: auto;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
            animation: slideInFromLeft 0.4s ease-out;
            display: flex;
            flex-direction: column;
            border-radius: 0;
        }
        
        @keyframes fadeInOverlay {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInFromLeft {
            from {
                opacity: 0;
                transform: translateX(-100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideOutToLeft {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(-100%);
            }
        }
        
        #manual-analysis-modal .modal-header {
            border-radius: 0;
            flex-shrink: 0;
        }
        
        #manual-analysis-modal .modal-body {
            flex: 1;
            overflow-y: auto;
        }
        
        #manual-analysis-modal .modal-footer {
            flex-shrink: 0;
            border-top: 1px solid #eee;
            background: #f9f9f9;
        }
        
        #manual-analysis-modal .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 28px;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        #manual-analysis-modal .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <!-- Welcome Modal -->
    <div id="welcome-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <img src="../SFDLoad.png" alt="SFD Logo" style="width: 150px; height: 150px; margin-bottom: 20px; display: block; margin-left: auto; margin-right: auto;">
                <h1>üîç‚öì Shipping Fraud Detection System</h1>
                <p>Claude-Powered Maritime Intelligence & Analysis Platform</p>
            </div>
            
            <div class="modal-body">
                <div class="welcome-section">
                    <h2>üéØ System Overview</h2>
                    <p style="color: #555; line-height: 1.6;">
                        This is a sophisticated AI-powered system designed to assist law enforcement in detecting 
                        and investigating maritime fraud using Automatic Identification System (AIS) data. 
                        The system combines advanced language AI (Claude) with geographic analysis tools and 
                        GPU-accelerated data processing.
                    </p>
                </div>
                
                <div class="welcome-section">
                    <h2>‚ú® Key Capabilities</h2>
                    <ul>
                        <li>Natural language interaction - ask questions in plain English</li>
                        <li>Detect 8 types of maritime anomalies (AIS beacon off/on, speed anomalies, COG/heading inconsistency, loitering, rendezvous, identity spoofing, zone violations)</li>
                        <li>Access NOAA AIS database (default data source) or use AWS S3/local data</li>
                        <li>Define and monitor custom geographic zones (polygons, circles, rectangles, ovals)</li>
                        <li>Generate interactive maps with clustering, heatmaps, and vessel tracks</li>
                        <li>Create charts and visualizations (bar, pie, 3D, scatterplot, time series)</li>
                        <li>Export professional reports (CSV, Excel, HTML)</li>
                        <li>Track specific vessels by MMSI across time periods</li>
                        <li>Filter by 58 vessel types across 8 categories</li>
                        <li>Identify high-risk vessels for investigation prioritization</li>
                    </ul>
                </div>
                
                <div class="requirements-box">
                    <h3>üìã What You'll Need to Proceed:</h3>
                    <ul>
                        <li><strong>Claude API Key</strong> - From console.anthropic.com (free tier available)</li>
                        <li><strong>Data Source</strong> - Default NOAA AIS database (no setup required), or optionally configure AWS S3 bucket or local folder with AIS data</li>
                        <li><strong>Optional: Custom AIS Data</strong> - CSV or Parquet format files (if not using NOAA default)</li>
                    </ul>
                </div>
                
                <div class="warning-box">
                    <strong>‚ö†Ô∏è Date Range Notice:</strong>
                    <p>This system can analyze data from <strong>January 1, 2021 onwards</strong>. 
                    Queries for dates before January 1, 2021 will not return results.</p>
                </div>
                
                <div class="welcome-section">
                    <h2>‚ö†Ô∏è WARNING</h2>
                    <p style="color: #555; line-height: 1.6; font-size: 14px;">
                        This system was designed to support law enforcement investigations. 
                        All data analysis must comply with applicable laws and regulations regarding 
                        data privacy, maritime jurisdiction, and law enforcement procedures.
                    </p>
                </div>
                
                <!-- Default Settings Section -->
                <div id="default-settings-section" class="welcome-section" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                    <h2>‚öôÔ∏è Current Settings</h2>
                    <div id="settings-display" style="background: #f9f9f9; padding: 15px; border-radius: 5px; margin-top: 10px;">
                        <p style="color: #666; font-style: italic;">Loading settings...</p>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button id="continue-btn" class="modal-btn modal-btn-primary" onclick="continueWithDefaults()" style="display: none;">
                    Continue with Default Settings
                </button>
                <button id="setup-btn" class="modal-btn modal-btn-primary" onclick="proceedToSetup()" style="display: none;">
                    Go to Setup
                </button>
                <button class="modal-btn modal-btn-secondary" onclick="closeApplication()">
                    Close This Page
                </button>
            </div>
        </div>
    </div>
    
    <!-- Manual Analysis Modal -->
    <div id="manual-analysis-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä Manual Analysis</h2>
                <button class="modal-close" onclick="closeManualAnalysisModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="manual-analysis-form">
                    <!-- Date Range -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label><strong>Date Range *</strong></label>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <input type="date" id="manual-start-date" required style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <span style="align-self: center;">to</span>
                            <input type="date" id="manual-end-date" required style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <!-- Vessel Types -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label><strong>Vessel Types</strong> (leave empty for all)</label>
                        <div id="manual-vessel-types" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; margin-top: 5px; background: #f9f9f9;">
                            <!-- Will be populated with checkboxes -->
                        </div>
                    </div>
                    
                    <!-- Anomaly Types -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label><strong>Anomaly Types</strong></label>
                        <div id="manual-anomaly-types" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; margin-top: 5px; background: #f9f9f9;">
                            <!-- Will be populated with checkboxes -->
                        </div>
                    </div>
                    
                    <!-- Output Formats -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label><strong>Output Formats</strong></label>
                        <div id="manual-output-formats" style="border: 1px solid #ddd; padding: 10px; border-radius: 4px; margin-top: 5px; background: #f9f9f9;">
                            <!-- Will be populated with checkboxes -->
                        </div>
                    </div>
                    
                    <div id="manual-analysis-status" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeManualAnalysisModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="submitManualAnalysis()">Run Analysis</button>
            </div>
        </div>
    </div>
    
    <div class="header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <img src="../SFDLoad.png" alt="SFD Logo" style="width: 40px; height: 40px;">
            <h1>üîç‚öì Shipping Fraud Detection System</h1>
        </div>
        <div class="header-info">
            <span id="session-info">Session: Loading...</span>
            <div id="cache-status" style="margin-left: 15px; font-size: 12px; opacity: 0.8; display: none;">
                üíæ <span id="cache-info"></span>
            </div>
            <span style="margin-left: 20px;">|</span>
            <a href="files.html" style="color: white; text-decoration: none; margin-left: 20px; opacity: 0.9; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'">
                üìÅ View Files
            </a>
            <span style="margin-left: 15px;">|</span>
            <a href="#" onclick="returnToSetup(); return false;" style="color: white; text-decoration: none; margin-left: 15px; opacity: 0.9; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'" title="Reconfigure settings or update credentials">
                ‚öôÔ∏è Reconfigure
            </a>
            <span style="margin-left: 15px;">|</span>
            <a href="#" onclick="showManualAnalysisModal(); return false;" style="color: white; text-decoration: none; margin-left: 15px; opacity: 0.9; transition: opacity 0.2s; background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 4px;" onmouseover="this.style.opacity='1'; this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.opacity='0.9'; this.style.background='rgba(255,255,255,0.2)'" title="Run analysis without LLM conversation">
                üìä Manual Analysis
            </a>
        </div>
    </div>
    
    <div class="main-container">
        <div class="map-panel" id="map-panel">
            <div id="map-container" style="width: 100%; height: 100%;"></div>
            <div class="map-placeholder" id="map-placeholder" style="display: none;">
                <h2 style="color: #999;">üìç Map Panel</h2>
                <p style="color: #bbb; margin-top: 10px;">Map will appear here after analysis</p>
            </div>
        </div>
        
        <div class="chat-panel">
            <div class="messages" id="messages">
                <!-- Messages will be added here -->
            </div>
            
            <div class="input-area">
                <div class="input-container">
                    <input 
                        type="text" 
                        id="message-input" 
                        placeholder="Ask about AIS anomalies, vessels, or geographic areas..."
                        autocomplete="off"
                    >
                    <button id="send-button" onclick="sendMessage()">Send</button>
                </div>
                <div class="tip">
                    üí° Tip: Ask about specific dates (Oct 15, 2024 - Mar 30, 2025), regions, or vessel MMSIs
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Frontend configuration - will be loaded from backend
        let API_BASE_URL = 'http://localhost:8000';  // Default fallback
        let WS_BASE_URL = 'ws://localhost:8000';     // Default fallback
        let sessionId = null;
        let ws = null;
        let isProcessing = false;
        
        // Load frontend configuration from backend on page load
        async function loadFrontendConfig() {
            try {
                // Try to get config from backend (uses default URL for initial request)
                const response = await fetch(`${API_BASE_URL}/api/frontend-config`);
                if (response.ok) {
                    const config = await response.json();
                    API_BASE_URL = config.api_base_url || API_BASE_URL;
                    WS_BASE_URL = config.ws_base_url || WS_BASE_URL;
                    console.log(`Frontend config loaded: API=${API_BASE_URL}, WS=${WS_BASE_URL}`);
                } else {
                    console.warn('Failed to load frontend config, using defaults');
                }
            } catch (error) {
                console.warn('Could not load frontend config from backend, using defaults:', error.message);
                // Continue with default values
            }
        }
        
        // ============================================================
        // ENHANCED DEBUGGING SYSTEM
        // ============================================================
        const DEBUG = {
            enabled: true,
            logs: [],
            
            log(category, message, data = null) {
                const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
                const logEntry = {
                    timestamp,
                    category,
                    message,
                    data: data ? JSON.parse(JSON.stringify(data)) : null
                };
                
                this.logs.push(logEntry);
                
                // Console output with color coding
                const colors = {
                    'INIT': 'color: #0066cc; font-weight: bold',
                    'VALIDATION': 'color: #9900cc; font-weight: bold',
                    'LOCALSTORAGE': 'color: #cc6600; font-weight: bold',
                    'NAVIGATION': 'color: #00cc66; font-weight: bold',
                    'ERROR': 'color: #cc0000; font-weight: bold',
                    'SUCCESS': 'color: #00cc00; font-weight: bold'
                };
                
                console.log(
                    `%c[${timestamp}] [${category}] ${message}`,
                    colors[category] || 'color: #666',
                    data || ''
                );
                
                // Update debug panel if exists
                this.updateDebugPanel();
            },
            
            getLogs() {
                return this.logs;
            },
            
            exportLogs() {
                return JSON.stringify(this.logs, null, 2);
            },
            
            updateDebugPanel() {
                const panel = document.getElementById('debug-panel');
                if (panel && panel.style.display !== 'none') {
                    this.showDebugPanel();
                }
            },
            
            showDebugPanel() {
                let panel = document.getElementById('debug-panel');
                if (!panel) {
                    panel = document.createElement('div');
                    panel.id = 'debug-panel';
                    panel.style.cssText = `
                        position: fixed;
                        top: 10px;
                        right: 10px;
                        width: 400px;
                        max-height: 80vh;
                        background: rgba(0, 0, 0, 0.95);
                        color: #0f0;
                        font-family: monospace;
                        font-size: 11px;
                        padding: 15px;
                        border: 2px solid #0f0;
                        border-radius: 5px;
                        z-index: 10000;
                        overflow-y: auto;
                    `;
                    document.body.appendChild(panel);
                }
                
                panel.style.display = 'block';
                
                // Get localStorage data
                const sessionId = localStorage.getItem('ais_session_id');
                const config = localStorage.getItem('ais_config');
                let configObj = null;
                try {
                    configObj = config ? JSON.parse(config) : null;
                } catch (e) {
                    configObj = { error: 'Failed to parse' };
                }
                
                // Build debug info
                let html = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong style="color: #0ff; font-size: 14px;">üêõ DEBUG PANEL</strong>
                        <button onclick="DEBUG.hideDebugPanel()" style="background: #f00; color: #fff; border: none; padding: 3px 8px; cursor: pointer; border-radius: 3px;">‚úï</button>
                    </div>
                    
                    <div style="border: 1px solid #0f0; padding: 8px; margin-bottom: 10px;">
                        <strong style="color: #ff0;">LOCALSTORAGE:</strong><br/>
                        <span style="color: ${sessionId ? '#0f0' : '#f00'}">
                            Session ID: ${sessionId ? '‚úì ' + sessionId.substr(0, 12) + '...' : '‚úó MISSING'}
                        </span><br/>
                        <span style="color: ${config ? '#0f0' : '#f00'}">
                            Config: ${config ? '‚úì Present' : '‚úó MISSING'}
                        </span><br/>
                    </div>
                    
                    ${configObj ? `
                    <div style="border: 1px solid #0f0; padding: 8px; margin-bottom: 10px;">
                        <strong style="color: #ff0;">CONFIG DETAILS:</strong><br/>
                        <span style="color: ${configObj.claude_api_key ? '#0f0' : '#f00'}">
                            Claude Key: ${configObj.claude_api_key ? '‚úì ' + configObj.claude_api_key.substring(0, 15) + '...' : '‚úó MISSING'}
                        </span><br/>
                        <span style="color: ${configObj.data_source ? '#0f0' : '#f00'}">
                            Data Source: ${configObj.data_source || '‚úó MISSING'}
                        </span><br/>
                        ${configObj.data_source === 'aws' ? `
                            <span style="color: ${configObj.aws?.bucket ? '#0f0' : '#f00'}">
                                AWS Bucket: ${configObj.aws?.bucket || '‚úó MISSING'}
                            </span><br/>
                            <span style="color: ${configObj.aws?.access_key ? '#0f0' : '#f00'}">
                                AWS Access Key: ${configObj.aws?.access_key ? '‚úì Present' : '‚úó MISSING'}
                            </span><br/>
                            <span style="color: ${configObj.aws?.secret_key ? '#0f0' : '#f00'}">
                                AWS Secret Key: ${configObj.aws?.secret_key ? '‚úì Present' : '‚úó MISSING'}
                            </span><br/>
                        ` : ''}
                        ${configObj.data_source === 'local' ? `
                            <span style="color: ${configObj.local?.path ? '#0f0' : '#f00'}">
                                Local Path: ${configObj.local?.path || '‚úó MISSING'}
                            </span><br/>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    <div style="border: 1px solid #0f0; padding: 8px; margin-bottom: 10px;">
                        <strong style="color: #ff0;">VALIDATION STATUS:</strong><br/>
                        <span style="color: ${isSystemConfigured() ? '#0f0' : '#f00'}">
                            ${isSystemConfigured() ? '‚úì SYSTEM CONFIGURED' : '‚úó SYSTEM NOT CONFIGURED'}
                        </span>
                    </div>
                    
                    <div style="border: 1px solid #0f0; padding: 8px; margin-bottom: 10px; max-height: 200px; overflow-y: auto;">
                        <strong style="color: #ff0;">RECENT LOGS (${this.logs.length}):</strong><br/>
                        ${this.logs.slice(-10).reverse().map(log => `
                            <div style="margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.1);">
                                <span style="color: #0ff">[${log.timestamp}]</span>
                                <span style="color: #ff0">[${log.category}]</span><br/>
                                <span style="color: #fff">${log.message}</span>
                                ${log.data ? `<br/><span style="color: #ccc; font-size: 10px;">${JSON.stringify(log.data).substring(0, 100)}</span>` : ''}
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <button onclick="DEBUG.clearStorage()" style="background: #f00; color: #fff; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; font-size: 10px;">Clear Storage</button>
                        <button onclick="DEBUG.copyLogs()" style="background: #00f; color: #fff; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; font-size: 10px;">Copy Logs</button>
                        <button onclick="location.reload()" style="background: #0a0; color: #fff; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; font-size: 10px;">Reload</button>
                        <button onclick="DEBUG.testValidation()" style="background: #a0a; color: #fff; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; font-size: 10px;">Test Validation</button>
                    </div>
                `;
                
                panel.innerHTML = html;
            },
            
            hideDebugPanel() {
                const panel = document.getElementById('debug-panel');
                if (panel) {
                    panel.style.display = 'none';
                }
            },
            
            clearStorage() {
                if (confirm('Clear all localStorage? This will require reconfiguration.')) {
                    this.log('LOCALSTORAGE', 'Clearing all localStorage');
                    localStorage.clear();
                    alert('Storage cleared! Reloading...');
                    location.reload();
                }
            },
            
            copyLogs() {
                const logs = this.exportLogs();
                navigator.clipboard.writeText(logs).then(() => {
                    alert('Logs copied to clipboard!');
                }).catch(() => {
                    alert('Failed to copy. Check console for logs.');
                    console.log('DEBUG LOGS:', logs);
                });
            },
            
            testValidation() {
                this.log('VALIDATION', 'Running manual validation test');
                const result = isSystemConfigured();
                alert(`Validation Result: ${result ? 'CONFIGURED ‚úì' : 'NOT CONFIGURED ‚úó'}\n\nCheck debug panel for details.`);
                this.showDebugPanel();
            }
        };
        
        // Show debug panel on Ctrl+D or Cmd+D
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                DEBUG.showDebugPanel();
            }
        });
        
        /**
         * Validate if configuration is complete
         */
        function isSystemConfigured() {
            DEBUG.log('VALIDATION', '=== STARTING VALIDATION CHECK ===');
            
            const sessionId = localStorage.getItem('ais_session_id');
            const savedConfig = localStorage.getItem('ais_config');
            
            DEBUG.log('LOCALSTORAGE', 'Retrieved localStorage items', {
                hasSessionId: !!sessionId,
                sessionIdLength: sessionId ? sessionId.length : 0,
                hasConfig: !!savedConfig,
                configLength: savedConfig ? savedConfig.length : 0
            });
            
            // Must have both session and config
            if (!sessionId || !savedConfig) {
                DEBUG.log('VALIDATION', 'FAILED: Missing session or config', {
                    sessionId: !!sessionId,
                    savedConfig: !!savedConfig
                });
                return false;
            }
            
            try {
                const config = JSON.parse(savedConfig);
                DEBUG.log('VALIDATION', 'Successfully parsed config', {
                    hasClaudeKey: !!config.claude_api_key,
                    claudeKeyLength: config.claude_api_key ? config.claude_api_key.length : 0,
                    claudeKeyPreview: config.claude_api_key ? config.claude_api_key.substring(0, 10) + '...' : 'MISSING',
                    dataSource: config.data_source,
                    source: config.source,
                    hasAws: !!config.aws,
                    hasLocal: !!config.local
                });
                
                // SPECIAL CASE: If configured from environment variables, we trust the backend
                // The backend has already validated everything, so we just need session + config marker
                if (config.source === 'environment_variables') {
                    DEBUG.log('VALIDATION', '‚úÖ CONFIGURED FROM ENVIRONMENT VARIABLES - Trusting backend validation');
                    // Still check that we have the basic structure
                    // NOAA is valid without aws/local config
                    if (config.data_source && (config.aws || config.local || config.data_source === 'noaa')) {
                        DEBUG.log('VALIDATION', '‚úÖ Environment config valid - session ready');
                        return true;
                    } else {
                        DEBUG.log('VALIDATION', 'FAILED: Environment config missing data_source or aws/local/noaa');
                        return false;
                    }
                }
                
                // Standard validation for manually configured sessions
                // Validate Claude API key (must exist and be non-empty, and not be placeholder)
                if (!config.claude_api_key || 
                    config.claude_api_key.trim() === '' || 
                    config.claude_api_key === '[configured_from_env]') {
                    DEBUG.log('VALIDATION', 'FAILED: Claude API key missing, empty, or placeholder', {
                        exists: !!config.claude_api_key,
                        isEmpty: config.claude_api_key ? config.claude_api_key.trim() === '' : 'N/A',
                        isPlaceholder: config.claude_api_key === '[configured_from_env]'
                    });
                    return false;
                }
                
                // Validate data source is selected
                if (!config.data_source || config.data_source.trim() === '') {
                    DEBUG.log('VALIDATION', 'FAILED: Data source not selected', {
                        dataSource: config.data_source
                    });
                    return false;
                }
                
                // Validate data source configuration
                if (config.data_source === 'aws') {
                    DEBUG.log('VALIDATION', 'Checking AWS configuration...');
                    
                    const hasValidAws = config.aws && 
                                       config.aws.bucket && 
                                       config.aws.bucket.trim() !== '' &&
                                       config.aws.access_key && 
                                       config.aws.access_key.trim() !== '' &&
                                       config.aws.secret_key && 
                                       config.aws.secret_key.trim() !== '';
                    
                    DEBUG.log('VALIDATION', 'AWS validation details', {
                        hasAwsObject: !!config.aws,
                        hasBucket: !!(config.aws && config.aws.bucket),
                        bucketValue: config.aws ? config.aws.bucket : 'NO AWS OBJECT',
                        hasAccessKey: !!(config.aws && config.aws.access_key),
                        hasSecretKey: !!(config.aws && config.aws.secret_key),
                        hasSessionToken: !!(config.aws && config.aws.session_token),
                        valid: hasValidAws
                    });
                    
                    if (!hasValidAws) {
                        DEBUG.log('VALIDATION', 'FAILED: AWS configuration incomplete');
                        return false;
                    }
                    DEBUG.log('VALIDATION', 'AWS configuration valid ‚úì');
                } else if (config.data_source === 'local') {
                    DEBUG.log('VALIDATION', 'Checking local configuration...');
                    
                    const hasValidLocal = config.local && 
                                         config.local.path && 
                                         config.local.path.trim() !== '';
                    
                    DEBUG.log('VALIDATION', 'Local validation details', {
                        hasLocalObject: !!config.local,
                        hasPath: !!(config.local && config.local.path),
                        pathValue: config.local ? config.local.path : 'NO LOCAL OBJECT',
                        valid: hasValidLocal
                    });
                    
                    if (!hasValidLocal) {
                        DEBUG.log('VALIDATION', 'FAILED: Local configuration incomplete');
                        return false;
                    }
                    DEBUG.log('VALIDATION', 'Local configuration valid ‚úì');
                } else if (config.data_source === 'noaa') {
                    DEBUG.log('VALIDATION', 'Checking NOAA configuration...');
                    // NOAA doesn't require additional config - it's always valid if selected
                    DEBUG.log('VALIDATION', 'NOAA configuration valid ‚úì');
                } else {
                    DEBUG.log('VALIDATION', 'FAILED: Unknown data source', {
                        dataSource: config.data_source
                    });
                    return false;
                }
                
                DEBUG.log('SUCCESS', '‚úì‚úì‚úì ALL VALIDATION PASSED ‚úì‚úì‚úì');
                return true;
                
            } catch (e) {
                DEBUG.log('ERROR', 'Failed to parse config', {
                    error: e.message,
                    stack: e.stack
                });
                return false;
            }
        }
        
        /**
         * Load and display default settings in the welcome modal
         */
        async function loadDefaultSettings() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/default-settings`);
                const data = await response.json();
                
                if (data.success) {
                    const settingsDisplay = document.getElementById('settings-display');
                    const continueBtn = document.getElementById('continue-btn');
                    const setupBtn = document.getElementById('setup-btn');
                    
                    // Build settings display HTML
                    let settingsHtml = '<div style="line-height: 1.8;">';
                    
                    // Data Source
                    settingsHtml += '<div style="margin-bottom: 12px;">';
                    settingsHtml += '<strong style="color: #333;">üìä Data Source:</strong><br>';
                    if (data.data_source.type === 'Not configured' || data.data_source.type === 'none') {
                        settingsHtml += '<span style="color: #d32f2f;">‚ùå Not configured</span>';
                    } else {
                        const details = data.data_source.details;
                        if (details.type === 'aws') {
                            settingsHtml += `<span style="color: #2e7d32;">‚úì AWS S3</span><br>`;
                            settingsHtml += `<span style="color: #666; font-size: 0.9em; margin-left: 20px;">Bucket: ${details.bucket || 'Not set'}</span><br>`;
                            if (details.prefix) {
                                settingsHtml += `<span style="color: #666; font-size: 0.9em; margin-left: 20px;">Prefix: ${details.prefix}</span><br>`;
                            }
                            settingsHtml += `<span style="color: #666; font-size: 0.9em; margin-left: 20px;">Region: ${details.region || 'Not set'}</span>`;
                        } else if (details.type === 'local') {
                            settingsHtml += `<span style="color: #2e7d32;">‚úì Local Folder</span><br>`;
                            settingsHtml += `<span style="color: #666; font-size: 0.9em; margin-left: 20px;">Path: ${details.path || 'Not set'}</span>`;
                        } else if (details.type === 'noaa') {
                            const isDefault = details.is_default || data.data_source.type === 'noaa';
                            const defaultLabel = isDefault ? ' (Default)' : '';
                            settingsHtml += `<span style="color: #2e7d32;">‚úì NOAA AIS Data${defaultLabel}</span><br>`;
                            settingsHtml += `<span style="color: #666; font-size: 0.9em; margin-left: 20px;">Cache: ${details.temp_dir || 'Default location'}</span>`;
                        }
                    }
                    settingsHtml += '</div>';
                    
                    // Output Folder
                    settingsHtml += '<div style="margin-bottom: 12px;">';
                    settingsHtml += '<strong style="color: #333;">üìÅ Output Folder:</strong><br>';
                    settingsHtml += `<span style="color: #666; font-size: 0.9em; margin-left: 20px;">${data.output_folder}</span>`;
                    settingsHtml += '</div>';
                    
                    // Claude API Key status
                    settingsHtml += '<div>';
                    settingsHtml += '<strong style="color: #333;">üîë Claude API Key:</strong><br>';
                    if (data.has_claude_key) {
                        settingsHtml += '<span style="color: #2e7d32;">‚úì Configured</span>';
                    } else {
                        settingsHtml += '<span style="color: #d32f2f;">‚ùå Not configured</span>';
                    }
                    settingsHtml += '</div>';
                    
                    settingsHtml += '</div>';
                    settingsDisplay.innerHTML = settingsHtml;
                    
                    // Show appropriate buttons based on whether defaults are acceptable
                    if (data.defaults_acceptable && data.has_claude_key) {
                        // Defaults are acceptable - show both buttons (user can continue or go to setup)
                        continueBtn.style.display = 'inline-block';
                        setupBtn.style.display = 'inline-block';
                        // Pre-initialize session in background since defaults are acceptable
                        preInitializeSessionInBackground();
                    } else {
                        // Defaults not acceptable or missing Claude key - only show setup button
                        continueBtn.style.display = 'none';
                        setupBtn.style.display = 'inline-block';
                    }
                } else {
                    // Error loading settings - show setup button
                    document.getElementById('settings-display').innerHTML = 
                        '<p style="color: #d32f2f;">‚ö†Ô∏è Could not load settings. Please configure the system.</p>';
                    document.getElementById('continue-btn').style.display = 'none';
                    document.getElementById('setup-btn').style.display = 'inline-block';
                }
            } catch (error) {
                console.error('Error loading default settings:', error);
                document.getElementById('settings-display').innerHTML = 
                    '<p style="color: #d32f2f;">‚ö†Ô∏è Error loading settings. Please configure the system.</p>';
                document.getElementById('continue-btn').style.display = 'none';
                document.getElementById('setup-btn').style.display = 'inline-block';
            }
        }
        
        /**
         * Pre-initialize session in background while modal is shown
         * This speeds up the apparent start time when user clicks "Continue"
         */
        async function preInitializeSessionInBackground() {
            try {
                DEBUG.log('PRE-INIT', 'Starting background session pre-initialization...');
                const response = await fetch(`${API_BASE_URL}/api/pre-initialize-session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Store pre-initialized session ID for later use
                    localStorage.setItem('pre_initialized_session_id', data.session_id);
                    DEBUG.log('PRE-INIT', `‚úÖ Session pre-initialized: ${data.session_id}`);
                } else {
                    DEBUG.log('PRE-INIT', `‚ö†Ô∏è Pre-initialization failed: ${data.error}`);
                    // Not critical - we'll initialize normally if this fails
                }
            } catch (error) {
                DEBUG.log('PRE-INIT', `‚ö†Ô∏è Pre-initialization error (non-critical): ${error.message}`);
                // Not critical - we'll initialize normally if this fails
            }
        }
        
        /**
         * Continue with default settings (skip setup)
         */
        async function continueWithDefaults() {
            DEBUG.log('NAVIGATION', 'User clicked "Continue with Default Settings" button');
            
            // Hide modal with fade out animation
            const modal = document.getElementById('welcome-modal');
            modal.style.opacity = '0';
            modal.style.transition = 'opacity 0.3s';
            
            setTimeout(async () => {
                modal.classList.add('hidden');
                
                DEBUG.log('NAVIGATION', 'Modal hidden, initializing session with defaults...');
                
                // Check if we have a pre-initialized session
                const preInitializedId = localStorage.getItem('pre_initialized_session_id');
                if (preInitializedId) {
                    DEBUG.log('NAVIGATION', 'Activating pre-initialized session...');
                    // Activate the pre-initialized session via setup-from-env
                    try {
                        const setupResponse = await fetch(`${API_BASE_URL}/api/setup-from-env`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        const setupResult = await setupResponse.json();
                        if (setupResult.success) {
                            // Store session ID and config
                            localStorage.setItem('ais_session_id', setupResult.session_id);
                            
                            // Store config marker for validation
                            const configToStore = {
                                data_source: setupResult.config.data_source || 'noaa',
                                source: 'environment_variables',
                                configured_at: new Date().toISOString()
                            };
                            if (setupResult.config.aws) {
                                configToStore.aws = setupResult.config.aws;
                            }
                            if (setupResult.config.local) {
                                configToStore.local = setupResult.config.local;
                            }
                            if (setupResult.config.noaa) {
                                configToStore.noaa = setupResult.config.noaa;
                            }
                            localStorage.setItem('ais_config', JSON.stringify(configToStore));
                            
                            localStorage.removeItem('pre_initialized_session_id');
                            DEBUG.log('NAVIGATION', `‚úÖ Pre-initialized session activated: ${setupResult.session_id}`);
                            
                            // Now initialize the session (which will use the stored session ID)
                            initializeSession();
                        } else {
                            DEBUG.log('NAVIGATION', `‚ö†Ô∏è Failed to activate pre-initialized session: ${setupResult.error}`);
                            showError(`Failed to initialize session: ${setupResult.error}`);
                        }
                    } catch (error) {
                        DEBUG.log('NAVIGATION', `‚ö†Ô∏è Error activating pre-initialized session: ${error.message}`);
                        showError(`Error initializing session: ${error.message}`);
                    }
                } else {
                    // No pre-initialized session, create one via setup-from-env
                    DEBUG.log('NAVIGATION', 'No pre-initialized session, creating new session...');
                    try {
                        const setupResponse = await fetch(`${API_BASE_URL}/api/setup-from-env`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        const setupResult = await setupResponse.json();
                        if (setupResult.success) {
                            // Store session ID and config
                            localStorage.setItem('ais_session_id', setupResult.session_id);
                            
                            // Store config marker for validation
                            const configToStore = {
                                data_source: setupResult.config.data_source || 'noaa',
                                source: 'environment_variables',
                                configured_at: new Date().toISOString()
                            };
                            if (setupResult.config.aws) {
                                configToStore.aws = setupResult.config.aws;
                            }
                            if (setupResult.config.local) {
                                configToStore.local = setupResult.config.local;
                            }
                            if (setupResult.config.noaa) {
                                configToStore.noaa = setupResult.config.noaa;
                            }
                            localStorage.setItem('ais_config', JSON.stringify(configToStore));
                            
                            DEBUG.log('NAVIGATION', `‚úÖ New session created: ${setupResult.session_id}`);
                            
                            // Now initialize the session (which will use the stored session ID)
                            initializeSession();
                        } else {
                            DEBUG.log('NAVIGATION', `‚ö†Ô∏è Failed to create session: ${setupResult.error}`);
                            showError(`Failed to initialize session: ${setupResult.error}`);
                        }
                    } catch (error) {
                        DEBUG.log('NAVIGATION', `‚ö†Ô∏è Error creating session: ${error.message}`);
                        showError(`Error initializing session: ${error.message}`);
                    }
                }
            }, 300);
        }
        
        /**
         * Proceed to setup or chat (depending on configuration status)
         */
        function proceedToSetup() {
            DEBUG.log('NAVIGATION', 'User clicked "OK - Proceed to Setup" button');
            
            // Hide modal with fade out animation
            const modal = document.getElementById('welcome-modal');
            modal.style.opacity = '0';
            modal.style.transition = 'opacity 0.3s';
            
            setTimeout(() => {
                modal.classList.add('hidden');
                
                DEBUG.log('NAVIGATION', 'Modal hidden, checking configuration...');
                
                // Check if system is fully configured
                if (isSystemConfigured()) {
                    DEBUG.log('NAVIGATION', '‚úì System configured - loading chat interface');
                    // Configuration is complete, initialize chat session
                    initializeSession();
                } else {
                    DEBUG.log('NAVIGATION', '‚úó System not configured - redirecting to setup.html');
                    // Configuration incomplete, redirect to setup
                    window.location.href = 'setup.html';
                }
            }, 300);
        }
        
        /**
         * Return to setup page (reconfiguration)
         */
        function returnToSetup() {
            if (confirm('Go to settings to reconfigure? Your conversation history will be preserved.')) {
                // Close websocket if open (will reconnect after reconfiguration)
                if (ws) {
                    ws.close();
                }
                // Redirect to setup with reconfigure flag
                window.location.href = 'setup.html?reconfigure=true';
            }
        }
        
        /**
         * Close the application window/tab
         */
        function closeApplication() {
            // Attempt to close the window/tab
            // Multiple methods for better browser compatibility
            
            // Method 1: Try to make window "closeable" by opening about:blank to self
            try {
                window.open('', '_self', '');
                window.close();
            } catch (e) {
                // If that fails, try direct close
                window.close();
            }
            
            // If window.close() doesn't work (most modern browsers block this),
            // show alternative instructions
            setTimeout(() => {
                if (!window.closed) {
                    const modal = document.getElementById('welcome-modal');
                    const modalBody = modal.querySelector('.modal-body');
                    modalBody.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px;">
                            <h2 style="color: #333; margin-bottom: 20px;">üö™ To Close This Page</h2>
                            <p style="color: #666; line-height: 1.8; font-size: 16px;">
                                For security reasons, browsers don't allow websites to close tabs automatically.
                            </p>
                            <p style="color: #666; line-height: 1.8; font-size: 16px; margin-top: 15px;">
                                Please use one of these methods:
                            </p>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: left;">
                                <p style="color: #555; margin: 10px 0;">
                                    <strong>Windows:</strong> Press <kbd style="background: #fff; padding: 3px 8px; border: 1px solid #ccc; border-radius: 3px;">Ctrl + W</kbd>
                                </p>
                                <p style="color: #555; margin: 10px 0;">
                                    <strong>Mac:</strong> Press <kbd style="background: #fff; padding: 3px 8px; border: 1px solid #ccc; border-radius: 3px;">‚åò + W</kbd>
                                </p>
                                <p style="color: #555; margin: 10px 0;">
                                    <strong>Or:</strong> Click the [X] button on your browser tab
                                </p>
                            </div>
                        </div>
                    `;
                    
                    // Update footer to show only OK button
                    const modalFooter = modal.querySelector('.modal-footer');
                    modalFooter.innerHTML = `
                        <button class="modal-btn modal-btn-primary" onclick="location.reload()">
                            Go Back
                        </button>
                    `;
                }
            }, 100);
        }
        
        /**
         * Check environment variables configuration and setup if available
         * Optimized: Only performs full connection test when needed
         */
        async function checkAndSetupFromEnv() {
            try {
                DEBUG.log('ENV', 'Checking for environment variable configuration...');
                const response = await fetch(`${API_BASE_URL}/api/check-env-config`);
                const result = await response.json();
                
                // Check if env is configured (lightweight check, no connection test)
                if (result.env_configured) {
                    DEBUG.log('ENV', '‚úÖ Environment variables found');
                    DEBUG.log('ENV', `Data source: ${result.data_source}`);
                    
                    // Setup from environment variables
                    const setupResponse = await fetch(`${API_BASE_URL}/api/setup-from-env`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const setupResult = await setupResponse.json();
                    
                    if (setupResult.success) {
                        DEBUG.log('ENV', '‚úÖ Setup from environment variables successful');
                        DEBUG.log('ENV', `Session ID: ${setupResult.session_id}`);
                        
                        // Store session ID
                        localStorage.setItem('ais_session_id', setupResult.session_id);
                        
                        // Store full config including AWS prefix and all settings
                        const configToStore = {
                            data_source: result.data_source,
                            source: 'environment_variables',
                            configured_at: new Date().toISOString()
                        };
                        
                        // Include AWS config if present (includes prefix)
                        if (setupResult.config && setupResult.config.aws) {
                            configToStore.aws = setupResult.config.aws;
                            DEBUG.log('ENV', `AWS Config saved:`, {
                                bucket: setupResult.config.aws.bucket,
                                prefix: setupResult.config.aws.prefix || '(empty)',
                                region: setupResult.config.aws.region,
                                hasAccessKey: !!setupResult.config.aws.access_key,
                                hasSecretKey: !!setupResult.config.aws.secret_key
                            });
                        }
                        
                        // Include local config if present
                        if (setupResult.config && setupResult.config.local) {
                            configToStore.local = setupResult.config.local;
                            DEBUG.log('ENV', `Local Config saved:`, {
                                path: setupResult.config.local.path,
                                file_format: setupResult.config.local.file_format
                            });
                        }
                        
                        // Mark as configured from environment variables
                        // Note: API key is not returned for security, but backend has validated it
                        configToStore.claude_api_key = '[configured_from_env]';
                        DEBUG.log('ENV', 'Marked as configured from environment variables');
                        
                        localStorage.setItem('ais_config', JSON.stringify(configToStore));
                        DEBUG.log('ENV', 'Configuration saved to localStorage');
                        
                        // Hide modal and initialize session
                        const modal = document.getElementById('welcome-modal');
                        modal.classList.add('hidden');
                        modal.style.display = 'none';
                        
                        DEBUG.log('ENV', 'Initializing session from environment variables...');
                        initializeSession();
                        return true;
                    } else {
                        DEBUG.log('ENV', `‚ùå Setup from env failed: ${setupResult.error}`);
                        return false;
                    }
                } else {
                    DEBUG.log('ENV', '‚ö†Ô∏è Environment variables not configured or connection failed');
                    if (result.env_configured && !result.success) {
                        DEBUG.log('ENV', `Connection test failed: ${result.connection_test?.error || 'Unknown error'}`);
                    }
                    return false;
                }
            } catch (error) {
                DEBUG.log('ENV', `‚ùå Error checking env config: ${error.message}`);
                return false;
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            DEBUG.log('INIT', '‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
            DEBUG.log('INIT', '‚ïë   PAGE LOAD - STARTING INITIALIZATION            ‚ïë');
            DEBUG.log('INIT', '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
            
            DEBUG.log('INIT', 'DOM Content Loaded event fired');
            DEBUG.log('INIT', 'Current URL: ' + window.location.href);
            
            // Try to restore state from sessionStorage
            const stateRestored = loadAppState();
            if (stateRestored) {
                DEBUG.log('INIT', '‚úÖ Restored app state from sessionStorage');
                // Restore map if we have a saved path
                if (appState.lastMapPath) {
                    setTimeout(() => {
                        loadMapInPanel(appState.lastMapPath);
                    }, 1000);
                }
            }
            
            // Check if returning from setup page
            const urlParams = new URLSearchParams(window.location.search);
            const fromSetup = urlParams.get('from') === 'setup';
            
            // First, load frontend configuration from backend (.env variables)
            await loadFrontendConfig();
            DEBUG.log('INIT', `Using API_BASE_URL: ${API_BASE_URL}`);
            DEBUG.log('INIT', `Using WS_BASE_URL: ${WS_BASE_URL}`);
            
            // Load default settings into welcome modal
            // (This will trigger pre-initialization if defaults are acceptable)
            await loadDefaultSettings();
            
            // If returning from setup, skip env check and go straight to session init
            if (fromSetup && isSystemConfigured()) {
                DEBUG.log('INIT', 'üöÄ RETURNING FROM SETUP - FAST LOAD');
                // Hide modal immediately
                const modal = document.getElementById('welcome-modal');
                modal.classList.add('hidden');
                modal.style.display = 'none';
                // Initialize session
                initializeSession();
            } else {
                // Normal initialization flow
                // Then, check for environment variable configuration
                const envSetupSuccess = await checkAndSetupFromEnv();
                
                if (envSetupSuccess) {
                    DEBUG.log('INIT', '‚úÖ INITIALIZED FROM ENVIRONMENT VARIABLES - SKIPPING MODAL');
                    // Session already initialized in checkAndSetupFromEnv
                } else {
                    // Check if system is already configured from previous session
                    const configured = isSystemConfigured();
                    
                    if (configured) {
                        DEBUG.log('INIT', '‚úÖ SYSTEM IS CONFIGURED (PREVIOUS SESSION) - SKIPPING MODAL, LOADING CHAT');
                        // Hide the modal immediately
                        const modal = document.getElementById('welcome-modal');
                        modal.classList.add('hidden');
                        modal.style.display = 'none';
                        DEBUG.log('NAVIGATION', 'Modal hidden immediately');
                        
                        // Initialize session directly
                        DEBUG.log('NAVIGATION', 'Calling initializeSession()...');
                        initializeSession();
                    } else {
                        DEBUG.log('INIT', '‚ö†Ô∏è SYSTEM NOT CONFIGURED - SHOWING WELCOME MODAL');
                        // Personalize welcome message if user has a name saved
                        personalizeWelcome();
                        
                        // Modal is shown by default (no 'hidden' class in HTML)
                        // User will need to click "OK - Proceed to Setup"
                        DEBUG.log('NAVIGATION', 'Welcome modal is visible, waiting for user action');
                    }
                }
            }
            
            // Handle Enter key in message input
            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !isProcessing) {
                    sendMessage();
                }
            });
            
            DEBUG.log('INIT', 'Initialization complete. Press Ctrl+D to show debug panel.');
        });
        
        /**
         * Personalize welcome message with user's name
         */
        function personalizeWelcome() {
            try {
                const savedConfig = localStorage.getItem('ais_config');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    if (config.user_name && config.user_name.trim()) {
                        const modalHeader = document.querySelector('#welcome-modal .modal-header');
                        const greeting = document.createElement('p');
                        greeting.style.cssText = 'font-size: 18px; margin-top: 10px; font-weight: 500; opacity: 1;';
                        greeting.textContent = `Welcome back, ${config.user_name}!`;
                        modalHeader.appendChild(greeting);
                    }
                }
            } catch (error) {
                console.error('Error personalizing welcome:', error);
            }
        }
        
        /**
         * Initialize session
         */
        async function initializeSession() {
            DEBUG.log('SESSION', '=== INITIALIZING SESSION ===');
            
            // Use centralized validation function first
            const isConfigured = isSystemConfigured();
            DEBUG.log('SESSION', `System configured: ${isConfigured}`);
            
            if (!isConfigured) {
                // Check if we have a pre-initialized session as fallback
                const preInitializedId = localStorage.getItem('pre_initialized_session_id');
                if (preInitializedId) {
                    DEBUG.log('SESSION', `System not configured but found pre-initialized session: ${preInitializedId}`);
                    // Activate it via setup-from-env (which will reuse the pre-initialized session)
                    try {
                        const setupResponse = await fetch(`${API_BASE_URL}/api/setup-from-env`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        const setupResult = await setupResponse.json();
                        if (setupResult.success) {
                            sessionId = setupResult.session_id;
                            localStorage.setItem('ais_session_id', sessionId);
                            
                            // Store config marker for validation
                            const configToStore = {
                                data_source: setupResult.config.data_source || 'noaa',
                                source: 'environment_variables',
                                configured_at: new Date().toISOString()
                            };
                            if (setupResult.config.aws) {
                                configToStore.aws = setupResult.config.aws;
                            }
                            if (setupResult.config.local) {
                                configToStore.local = setupResult.config.local;
                            }
                            if (setupResult.config.noaa) {
                                configToStore.noaa = setupResult.config.noaa;
                            }
                            localStorage.setItem('ais_config', JSON.stringify(configToStore));
                            
                            localStorage.removeItem('pre_initialized_session_id');
                            DEBUG.log('SESSION', `‚úÖ Pre-initialized session activated: ${sessionId}`);
                            
                            document.getElementById('session-info').textContent = `Session: ${sessionId ? sessionId.substr(0, 8) : '...'}...`;
                            
                            // Connect WebSocket
                            connectWebSocket();
                            return;
                        } else {
                            DEBUG.log('SESSION', `‚ö†Ô∏è Failed to activate pre-initialized session: ${setupResult.error}`);
                            // Clear the failed pre-initialized ID and fall through to error
                            localStorage.removeItem('pre_initialized_session_id');
                        }
                    } catch (error) {
                        DEBUG.log('SESSION', `‚ö†Ô∏è Error activating pre-initialized session: ${error.message}`);
                        // Clear the failed pre-initialized ID and fall through to error
                        localStorage.removeItem('pre_initialized_session_id');
                    }
                }
                
                // No valid session found, redirect to setup
                DEBUG.log('SESSION', '‚ùå System not configured - redirecting to setup');
                showError('System not configured. Redirecting to setup...');
                setTimeout(() => {
                    window.location.href = 'setup.html';
                }, 2000);
                return;
            }
            
            DEBUG.log('SESSION', '‚úÖ System configured - proceeding with session initialization');
            
            // Get session ID (we know it exists from validation)
            sessionId = localStorage.getItem('ais_session_id');
            
            if (!sessionId) {
                DEBUG.log('SESSION', '‚ö†Ô∏è No session ID found, but system is configured. This should not happen.');
                showError('Session ID missing. Please refresh the page.');
                return;
            }
            
            document.getElementById('session-info').textContent = `Session: ${sessionId ? sessionId.substr(0, 8) : '...'}...`;
            
            // Connect WebSocket
            connectWebSocket();
        }
        
        /**
         * Connect to WebSocket
         */
        function connectWebSocket() {
            ws = new WebSocket(`${WS_BASE_URL}/ws/chat/${sessionId}`);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                // Personalized greeting
                const savedConfig = localStorage.getItem('ais_config');
                let greeting = 'Hello!';
                try {
                    if (savedConfig) {
                        const config = JSON.parse(savedConfig);
                        if (config.user_name && config.user_name.trim()) {
                            greeting = `Hello, ${config.user_name}!`;
                        }
                    }
                } catch (e) {
                    console.error('Error loading user name:', e);
                }
                addMessage('assistant', `${greeting} I'm your AIS fraud detection assistant. I can help you analyze vessel movements and detect suspicious activities from January 1, 2021 onwards. How can I assist you today?`);
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('Failed to parse WebSocket message:', error);
                    showError('Received invalid message from server. Please refresh the page.');
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                showError('Connection error. Please check if the backend server is running.');
                isProcessing = false;
                updateSendButton();
            };
            
            ws.onclose = (event) => {
                console.log('WebSocket closed', event.code, event.reason);
                isProcessing = false;
                updateSendButton();
                
                // Handle specific close codes
                if (event.code === 1008) {
                    // Session not found - redirect to setup
                    showError('Session expired or not found. Redirecting to setup...');
                    addMessage('assistant', '‚ö†Ô∏è Session expired or not found. Please reconfigure the system.', 'error');
                    setTimeout(() => {
                        window.location.href = 'setup.html';
                    }, 2000);
                } else if (event.code === 1011) {
                    // Internal server error
                    showError('Server encountered an error. The connection was closed.');
                    addMessage('assistant', '‚ö†Ô∏è Server error occurred. Please try refreshing the page or restarting the backend server.', 'error');
                } else if (event.code === 1006) {
                    // Abnormal closure (no close frame received)
                    showError('Connection lost. This may be due to network issues or the server being unavailable.');
                    addMessage('assistant', '‚ö†Ô∏è Connection lost. Please check if the backend server is running on port 8000.', 'error');
                } else if (event.code !== 1000) {
                    // Other abnormal closure - show error but don't redirect
                    const reason = event.reason || `Close code: ${event.code}`;
                    showError(`Connection closed unexpectedly: ${reason}`);
                    addMessage('assistant', `‚ö†Ô∏è Connection closed: ${reason}. Please try refreshing the page.`, 'error');
                } else {
                    // Normal closure (1000) - connection closed cleanly
                    console.log('WebSocket closed normally');
                }
            };
        }
        
        /**
         * Handle WebSocket messages
         */
        function handleWebSocketMessage(data) {
            if (!data || typeof data !== 'object') {
                console.error('Invalid WebSocket message format:', data);
                return;
            }
            
            if (data.type === 'message') {
                addMessage('assistant', data.content);
                isProcessing = false;
                updateSendButton();
            } else if (data.type === 'tools_executing') {
                addMessage('assistant', `üîß Executing: ${data.tools ? data.tools.join(', ') : 'tools'}...`);
            } else if (data.type === 'analysis_complete') {
                // Analysis completed - fetch full results from server-side storage
                console.log('Analysis complete, fetching results from server:', data.analysis_id);
                
                // Fetch full analysis result from server
                fetchLatestAnalysisAndUpdateUI(data.analysis_id, data.files_generated || []);
                
                // Also update map with anomalies
                setTimeout(() => {
                    fetchAnomaliesForMap();
                }, 1000); // Wait a bit for results to be stored
                
            } else if (data.type === 'tool_result') {
                console.log('Tool result:', data.tool_name, data.result);
                DEBUG.log('TOOL_RESULT', `Tool: ${data.tool_name}`, data.result);
                
                // Check if tool result contains popup request
                if (data.result && data.result.action) {
                    console.log(`[POPUP] Detected popup request: ${data.result.action}`);
                    DEBUG.log('POPUP', `Triggering popup: ${data.result.action}`, data.result);
                    handlePopupRequest(data.result);
                }
                
                // Check if tool result contains a map file (for other tools like create_all_anomalies_map)
                if (data.result && data.result.file_path && 
                    (data.tool_name === 'create_all_anomalies_map' || 
                     data.tool_name === 'create_anomaly_heatmap')) {
                    loadMapInPanel(data.result.file_path);
                }
                
                // Check if tool result contains error
                if (data.result && data.result.error) {
                    showError(`Tool execution error: ${data.result.error}`);
                    isProcessing = false;
                    updateSendButton();
                }
            } else if (data.type === 'progress') {
                // Display progress updates as status messages
                addMessage('assistant', data.message || 'Processing...', 'progress');
                console.log('Progress:', data.stage, data.message, data.data);
            } else if (data.type === 'keepalive') {
                // Silently handle keepalive messages to maintain connection
                // No action needed - just keeps WebSocket connection alive
                DEBUG.log('WEBSOCKET', 'Keepalive received');
            } else if (data.type === 'error') {
                // Handle explicit error messages from backend
                const errorMsg = data.content || data.message || 'An error occurred';
                showError(errorMsg);
                // Also add as assistant message so it appears in chat
                addMessage('assistant', `‚ö†Ô∏è ${errorMsg}`, 'error');
                isProcessing = false;
                updateSendButton();
            } else {
                console.warn('Unknown WebSocket message type:', data.type, data);
            }
        }
        
        /**
         * Update cache status display (Phase 5)
         */
        function updateCacheStatus(analysisResult) {
            const cacheStatus = document.getElementById('cache-status');
            const cacheInfo = document.getElementById('cache-info');
            
            if (cacheStatus && cacheInfo && analysisResult) {
                const dateRange = analysisResult.date_range || {};
                const start = dateRange.start || 'unknown';
                const end = dateRange.end || 'unknown';
                const recordCount = analysisResult.total_records || 0;
                
                cacheInfo.textContent = `Loaded: ${start} to ${end} (${recordCount.toLocaleString()} records)`;
                cacheStatus.style.display = 'block';
                
                // If cache hit
                if (analysisResult.cache_hit) {
                    const hitCount = analysisResult.cache_hit_count || 0;
                    const newCount = analysisResult.new_load_count || 0;
                    if (hitCount > 0 && newCount === 0) {
                        cacheInfo.textContent += ' [Cache Hit - Instant!]';
                        cacheInfo.style.color = '#4CAF50';
                    } else if (hitCount > 0) {
                        cacheInfo.textContent += ` [${hitCount} cached, ${newCount} new]`;
                        cacheInfo.style.color = '#2196F3';
                    }
                }
            }
        }
        
        /**
         * Load map into the map panel
         */
        /**
         * Fetch latest analysis results from server-side storage and update UI
         */
        async function fetchLatestAnalysisAndUpdateUI(analysisId, filesGenerated) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/sessions/${sessionId}/latest-analysis`);
                const data = await response.json();
                
                if (data.success && data.result) {
                    const result = data.result;
                    
                    // Update map with anomalies
                    if (result.anomalies && result.anomalies.length > 0) {
                        updateMapWithAnomalies(result.anomalies);
                    } else {
                        // Try to fetch anomalies for map if not in result
                        fetchAnomaliesForMap();
                    }
                    console.log('Fetched analysis result from server:', result);
                    
                    // Mark analysis as completed
                    analysisWorkflowState.analysisCompleted = true;
                    analysisWorkflowState.lastAnalysisId = result.analysis_id;
                    saveAppState();
                    
                    // Update map panel with anomalies map (preferred method - loads full HTML map)
                    if (result.files_generated && result.files_generated.length > 0) {
                        // Prefer the unified "All Anomalies" map if available
                        let mapFile = result.files_generated.find(f => 
                            f.type === 'map' && typeof f.name === 'string' && /all anomalies|event map/i.test(f.name)
                        );
                        // Fallback: first map file
                        if (!mapFile) {
                            mapFile = result.files_generated.find(f => f.type === 'map');
                        }
                        if (mapFile && mapFile.path) {
                            loadMapInPanel(mapFile.path);
                        }
                    } else if (result.anomalies && result.anomalies.length > 0) {
                        // Fallback: use simple markers if no generated map
                        updateMapWithAnomalies(result.anomalies);
                    }
                    
                    // Update cache status display
                    if (result.statistics) {
                        updateCacheStatus(result);
                    }
                    
                    // Notify user that files are available
                    addMessage('assistant', 'üìÅ Analysis results are available in the Files tab. The anomalies map has been loaded.', 'info');
                } else {
                    console.error('Failed to fetch analysis result:', data.error);
                    // Fallback: try to use files_generated from the notification
                    if (filesGenerated && filesGenerated.length > 0) {
                        let mapFile = filesGenerated.find(f => 
                            f.type === 'map' && typeof f.name === 'string' && /all anomalies/i.test(f.name)
                        );
                        if (!mapFile) {
                            mapFile = filesGenerated.find(f => f.type === 'map');
                        }
                        if (mapFile && mapFile.path) {
                            loadMapInPanel(mapFile.path);
                        }
                    }
                }
            } catch (error) {
                console.error('Error fetching analysis result:', error);
                // Fallback: try to use files_generated from the notification
                if (filesGenerated && filesGenerated.length > 0) {
                    let mapFile = filesGenerated.find(f => 
                        f.type === 'map' && typeof f.name === 'string' && /all anomalies/i.test(f.name)
                    );
                    if (!mapFile) {
                        mapFile = filesGenerated.find(f => f.type === 'map');
                    }
                    if (mapFile && mapFile.path) {
                        loadMapInPanel(mapFile.path);
                    }
                }
            }
        }
        
        function loadMapInPanel(filePath) {
            console.log('Loading generated map into panel:', filePath);
            
            // Store the map path for state persistence
            appState.lastMapPath = filePath;
            saveAppState();
            
            const mapPanel = document.getElementById('map-panel');
            const placeholder = document.getElementById('map-placeholder');
            
            // Remove placeholder if it exists
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            
            // Remove existing iframe and Leaflet map if any
            const existingIframe = mapPanel.querySelector('iframe');
            if (existingIframe) {
                existingIframe.remove();
            }
            
            // Remove Leaflet map container if it exists (we're replacing it with iframe)
            const mapContainer = document.getElementById('map-container');
            if (mapContainer) {
                // Destroy Leaflet map if it exists
                if (mainMap) {
                    mainMap.remove();
                    mainMap = null;
                }
                if (manualAnalysisMap) {
                    manualAnalysisMap.remove();
                    manualAnalysisMap = null;
                }
                // Hide the container (iframe will be added to map-panel instead)
                mapContainer.style.display = 'none';
            }
            
            // Extract filename from path to use with API endpoint
            const fileName = filePath.split(/[/\\]/).pop();
            
            // Find the file ID by fetching the file list and matching the filename
            // For now, use a simpler approach: construct the API URL directly
            // The file path should be relative to the output directory
            // We'll use the files API to get the proper file ID
            fetch(`${API_BASE_URL}/api/files/list`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.files) {
                        // Find the file by matching the filename
                        const file = data.files.find(f => f.name === fileName || f.path === filePath);
                        if (file) {
                            // Use the API endpoint to view the file
                            const iframe = document.createElement('iframe');
                            iframe.src = `${API_BASE_URL}/api/files/view/${file.id}`;
                            iframe.style.width = '100%';
                            iframe.style.height = '100%';
                            iframe.style.border = 'none';
                            mapPanel.appendChild(iframe);
                            console.log('Map loaded successfully via API');
                        } else {
                            // Fallback: try direct file path (may not work in all browsers)
                            console.warn('File not found in API, trying direct path');
                            const iframe = document.createElement('iframe');
                            iframe.src = `file:///${filePath.replace(/\\/g, '/')}`;
                            iframe.style.width = '100%';
                            iframe.style.height = '100%';
                            iframe.style.border = 'none';
                            mapPanel.appendChild(iframe);
                        }
                    } else {
                        // Fallback: try direct file path
                        console.warn('Could not fetch file list, trying direct path');
                        const iframe = document.createElement('iframe');
                        iframe.src = `file:///${filePath.replace(/\\/g, '/')}`;
                        iframe.style.width = '100%';
                        iframe.style.height = '100%';
                        iframe.style.border = 'none';
                        mapPanel.appendChild(iframe);
                    }
                })
                .catch(error => {
                    console.error('Error loading map via API, trying direct path:', error);
                    // Fallback: try direct file path
                    const iframe = document.createElement('iframe');
                    iframe.src = `file:///${filePath.replace(/\\/g, '/')}`;
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    iframe.style.border = 'none';
                    mapPanel.appendChild(iframe);
                });
        }
        
        /**
         * Handle popup requests from LLM tools
         * Includes debouncing to prevent duplicate popups
         */
        let lastToolCall = {};
        
        function handlePopupRequest(result) {
            const action = result.action;
            
            // Create unique key for this tool call
            const toolKey = `${action}_${JSON.stringify(result.message || '')}`;
            const now = Date.now();
            
            // Debounce: Ignore duplicate calls within 5 seconds
            if (lastToolCall[toolKey] && (now - lastToolCall[toolKey]) < 5000) {
                console.log(`[DEBOUNCE] Ignoring duplicate tool call: ${action}`);
                return;
            }
            
            lastToolCall[toolKey] = now;
            console.log(`[TOOL] Processing: ${action}`);
            
            if (action === 'show_date_picker') {
                showDatePickerDialog(result);
            } else if (action === 'show_vessel_type_picker') {
                showVesselTypePickerDialog(result);
            } else if (action === 'show_anomaly_picker') {
                showAnomalyPickerDialog(result);
            } else if (action === 'show_output_picker') {
                showOutputPickerDialog(result);
            }
        }
        
        /**
         * Analysis workflow state management
         */
        let analysisWorkflowState = {
            active: false,
            step: 0,
            selections: {
                date_range: null,
                vessel_types: null,
                anomaly_types: null,
                output_formats: null
            },
            analysisCompleted: false,  // Flag to prevent restarting analysis
            lastAnalysisId: null       // Store last analysis ID
        };
        
        // State persistence - prevent reset when navigating
        let appState = {
            sessionInitialized: false,
            mapInitialized: false,
            lastMapPath: null,
            preserveOnNavigation: true
        };
        
        // Save state to sessionStorage
        function saveAppState() {
            try {
                sessionStorage.setItem('ais_app_state', JSON.stringify({
                    analysisWorkflowState: analysisWorkflowState,
                    appState: appState,
                    sessionId: sessionId
                }));
            } catch (e) {
                console.warn('Could not save app state:', e);
            }
        }
        
        // Load state from sessionStorage
        function loadAppState() {
            try {
                const saved = sessionStorage.getItem('ais_app_state');
                if (saved) {
                    const state = JSON.parse(saved);
                    if (state.sessionId === sessionId) {
                        analysisWorkflowState = state.analysisWorkflowState || analysisWorkflowState;
                        appState = state.appState || appState;
                        return true;
                    }
                }
            } catch (e) {
                console.warn('Could not load app state:', e);
            }
            return false;
        }
        
        /**
         * Detect if user wants to start an analysis
         * Note: This is kept for potential frontend UI hints, but the LLM will handle workflow triggering
         */
        function detectAnalysisIntent(message) {
            const lowerMessage = message.toLowerCase();
            const analysisKeywords = [
                'start analysis', 'run analysis', 'new analysis', 'conduct analysis',
                'analyze', 'analyzing', 'analysis',
                'look at', 'examine', 'check', 'investigate', 'review',
                'detect anomalies', 'find anomalies', 'check for anomalies', 'search for', 'scan',
                'begin analysis', 'perform analysis', 'execute analysis'
            ];
            
            return analysisKeywords.some(keyword => lowerMessage.includes(keyword));
        }
        
        /**
         * Start the sequential analysis workflow
         */
        function startAnalysisWorkflow() {
            // Prevent restarting if analysis already completed and flag is set
            if (analysisWorkflowState.analysisCompleted && appState.preserveOnNavigation) {
                console.log('Analysis already completed - preventing restart');
                addMessage('assistant', 'Analysis has already been completed. Use the Files tab to view results, or start a new analysis with different parameters.', 'info');
                return;
            }
            
            if (analysisWorkflowState.active) {
                console.log('Analysis workflow already active');
                return;
            }
            
            analysisWorkflowState.active = true;
            analysisWorkflowState.step = 0;
            analysisWorkflowState.selections = {
                date_range: null,
                vessel_types: null,
                anomaly_types: null,
                output_formats: null
            };
            saveAppState();
            
            // Start with date picker
            showDatePickerDialog({
                message: 'Step 1 of 4: Select the date range for analysis',
                default_start: '2024-01-01',
                default_end: new Date().toISOString().split('T')[0],
                min_date: '2021-01-01',
                max_date: new Date().toISOString().split('T')[0]
            });
        }
        
        /**
         * Continue to next step in analysis workflow
         */
        function continueAnalysisWorkflow() {
            if (!analysisWorkflowState.active) return;
            
            analysisWorkflowState.step++;
            
            if (analysisWorkflowState.step === 1) {
                // Step 2: Vessel types - Show ALL 58 vessel types across 8 categories
                showVesselTypePickerDialog({
                    message: 'Step 2 of 4: Select vessel types to analyze',
                    vessel_types_by_category: [
                        {
                            category: 'WIG',
                            code_range: '20-29',
                            count: 5,
                            types: [
                                { code: 20, name: 'Wing in ground (WIG), all ships of this type', description: 'Ground-effect vehicles' },
                                { code: 21, name: 'Wing in ground (WIG), Hazardous category A', description: 'WIG carrying hazardous materials category A' },
                                { code: 22, name: 'Wing in ground (WIG), Hazardous category B', description: 'WIG carrying hazardous materials category B' },
                                { code: 23, name: 'Wing in ground (WIG), Hazardous category C', description: 'WIG carrying hazardous materials category C' },
                                { code: 24, name: 'Wing in ground (WIG), Hazardous category D', description: 'WIG carrying hazardous materials category D' }
                            ]
                        },
                        {
                            category: 'Special',
                            code_range: '30-39',
                            count: 10,
                            types: [
                                { code: 30, name: 'Fishing', description: 'Commercial fishing vessels' },
                                { code: 31, name: 'Towing', description: 'Towing vessels' },
                                { code: 32, name: 'Towing: length exceeds 200m or breadth exceeds 25m', description: 'Large towing operations' },
                                { code: 33, name: 'Dredging or underwater ops', description: 'Dredging or underwater operations' },
                                { code: 34, name: 'Diving ops', description: 'Diving support vessels' },
                                { code: 35, name: 'Military ops', description: 'Military operations vessels' },
                                { code: 36, name: 'Sailing', description: 'Sailing vessels' },
                                { code: 37, name: 'Pleasure Craft', description: 'Recreational pleasure craft' },
                                { code: 38, name: 'Reserved', description: 'Reserved ship type' },
                                { code: 39, name: 'Reserved', description: 'Reserved ship type' }
                            ]
                        },
                        {
                            category: 'HSC',
                            code_range: '40-49',
                            count: 10,
                            types: [
                                { code: 40, name: 'High speed craft (HSC), all ships of this type', description: 'High-speed craft (HSC)' },
                                { code: 41, name: 'High speed craft (HSC), Hazardous category A', description: 'HSC carrying hazardous materials category A' },
                                { code: 42, name: 'High speed craft (HSC), Hazardous category B', description: 'HSC carrying hazardous materials category B' },
                                { code: 43, name: 'High speed craft (HSC), Hazardous category C', description: 'HSC carrying hazardous materials category C' },
                                { code: 44, name: 'High speed craft (HSC), Hazardous category D', description: 'HSC carrying hazardous materials category D' },
                                { code: 45, name: 'High speed craft (HSC), Reserved', description: 'HSC reserved type' },
                                { code: 46, name: 'High speed craft (HSC), Reserved', description: 'HSC reserved type' },
                                { code: 47, name: 'High speed craft (HSC), Reserved', description: 'HSC reserved type' },
                                { code: 48, name: 'High speed craft (HSC), Reserved', description: 'HSC reserved type' },
                                { code: 49, name: 'High speed craft (HSC), No additional information', description: 'HSC without specific subtype' }
                            ]
                        },
                        {
                            category: 'Special Purpose',
                            code_range: '50-59',
                            count: 10,
                            types: [
                                { code: 50, name: 'Pilot Vessel', description: 'Harbor pilot vessels' },
                                { code: 51, name: 'Search and Rescue vessel', description: 'SAR vessels' },
                                { code: 52, name: 'Tug', description: 'Tugboats' },
                                { code: 53, name: 'Port Tender', description: 'Port service vessels' },
                                { code: 54, name: 'Anti-pollution equipment', description: 'Environmental response vessels' },
                                { code: 55, name: 'Law Enforcement', description: 'Coast guard, police vessels' },
                                { code: 56, name: 'Spare - Local Vessel', description: 'Local/spare designation' },
                                { code: 57, name: 'Spare - Local Vessel', description: 'Local/spare designation' },
                                { code: 58, name: 'Medical Transport', description: 'Hospital/ambulance ships' },
                                { code: 59, name: 'Noncombatant ship (RR Resolution No. 18)', description: 'Noncombatant vessels' }
                            ]
                        },
                        {
                            category: 'Passenger',
                            code_range: '60-69',
                            count: 6,
                            types: [
                                { code: 60, name: 'Passenger, all ships of this type', description: 'Passenger vessels' },
                                { code: 61, name: 'Passenger, Hazardous category A', description: 'Passenger ships carrying hazardous materials category A' },
                                { code: 62, name: 'Passenger, Hazardous category B', description: 'Passenger ships carrying hazardous materials category B' },
                                { code: 63, name: 'Passenger, Hazardous category C', description: 'Passenger ships carrying hazardous materials category C' },
                                { code: 64, name: 'Passenger, Hazardous category D', description: 'Passenger ships carrying hazardous materials category D' },
                                { code: 69, name: 'Passenger, No additional information', description: 'Passenger ships without specific subtype' }
                            ]
                        },
                        {
                            category: 'Cargo',
                            code_range: '70-79',
                            count: 6,
                            types: [
                                { code: 70, name: 'Cargo, all ships of this type', description: 'Cargo vessels' },
                                { code: 71, name: 'Cargo, Hazardous category A', description: 'Cargo ships carrying hazardous materials category A' },
                                { code: 72, name: 'Cargo, Hazardous category B', description: 'Cargo ships carrying hazardous materials category B' },
                                { code: 73, name: 'Cargo, Hazardous category C', description: 'Cargo ships carrying hazardous materials category C' },
                                { code: 74, name: 'Cargo, Hazardous category D', description: 'Cargo ships carrying hazardous materials category D' },
                                { code: 79, name: 'Cargo, No additional information', description: 'Cargo ships without specific subtype' }
                            ]
                        },
                        {
                            category: 'Tanker',
                            code_range: '80-89',
                            count: 6,
                            types: [
                                { code: 80, name: 'Tanker, all ships of this type', description: 'Oil/chemical tankers' },
                                { code: 81, name: 'Tanker, Hazardous category A', description: 'Tankers carrying hazardous materials category A' },
                                { code: 82, name: 'Tanker, Hazardous category B', description: 'Tankers carrying hazardous materials category B' },
                                { code: 83, name: 'Tanker, Hazardous category C', description: 'Tankers carrying hazardous materials category C' },
                                { code: 84, name: 'Tanker, Hazardous category D', description: 'Tankers carrying hazardous materials category D' },
                                { code: 89, name: 'Tanker, No additional information', description: 'Tankers without specific subtype' }
                            ]
                        },
                        {
                            category: 'Other',
                            code_range: '90-99',
                            count: 5,
                            types: [
                                { code: 90, name: 'Other Type, all ships of this type', description: 'Other vessel types' },
                                { code: 91, name: 'Other Type, Hazardous category A', description: 'Other vessels carrying hazardous materials category A' },
                                { code: 92, name: 'Other Type, Hazardous category B', description: 'Other vessels carrying hazardous materials category B' },
                                { code: 93, name: 'Other Type, Hazardous category C', description: 'Other vessels carrying hazardous materials category C' },
                                { code: 94, name: 'Other Type, Hazardous category D', description: 'Other vessels carrying hazardous materials category D' }
                            ]
                        }
                    ],
                    default_types: ['Cargo', 'Tanker'],
                    allow_multiple: true,
                    popup_type: 'vessel_type_selection'
                });
            } else if (analysisWorkflowState.step === 2) {
                // Step 3: Anomaly types
                showAnomalyPickerDialog({
                    message: 'Step 3 of 4: Select anomaly types to detect',
                    options: [
                        {
                            value: 'ais_beacon_on',
                            label: 'AIS Beacon On',
                            description: 'Vessel reappears after being off for an extended period'
                        },
                        {
                            value: 'ais_beacon_off',
                            label: 'AIS Beacon Off',
                            description: 'Vessel disappears for an extended period (>6 hours)'
                        },
                        {
                            value: 'excessive_travel_distance_fast',
                            label: 'Speed Anomalies',
                            description: 'Impossible travel distances between positions'
                        },
                        {
                            value: 'cog-heading_inconsistency',
                            label: 'COG/Heading Inconsistency',
                            description: 'Large difference between course and heading at speed'
                        },
                        {
                            value: 'loitering',
                            label: 'Loitering',
                            description: 'Extended presence in a small area (24+ hours)'
                        }
                    ],
                    default_types: [
                        'ais_beacon_on',
                        'ais_beacon_off',
                        'excessive_travel_distance_fast',
                        'cog-heading_inconsistency',
                        'loitering'
                    ],
                    allow_multiple: true,
                    popup_type: 'anomaly_selection'
                });
            } else if (analysisWorkflowState.step === 3) {
                // Step 4: Output formats
                showOutputPickerDialog({
                    message: 'Step 4 of 4: Select output formats to generate',
                    options: [
                        {
                            value: 'consolidated_events_csv',
                            label: 'Consolidated Events CSV',
                            description: 'All detected anomalies in CSV format'
                        },
                        {
                            value: 'heatmap',
                            label: 'Anomaly Heatmap',
                            description: 'Geographic heatmap showing anomaly density'
                        },
                        {
                            value: 'event_map',
                            label: 'Event Map',
                            description: 'Interactive map with all anomaly locations'
                        },
                        {
                            value: 'statistics_csv',
                            label: 'Statistics CSV',
                            description: 'Summary statistics in CSV format'
                        },
                        {
                            value: 'excel_report',
                            label: 'Excel Report',
                            description: 'Comprehensive Excel report with multiple sheets'
                        },
                        {
                            value: 'vessel_tracks',
                            label: 'Vessel Track Maps',
                            description: 'Individual track maps for vessels with anomalies'
                        }
                    ],
                    default_outputs: [
                        'consolidated_events_csv',
                        'event_map',
                        'statistics_csv',
                        'excel_report'
                    ],
                    allow_multiple: true,
                    popup_type: 'output_selection'
                });
            } else if (analysisWorkflowState.step === 4) {
                // Final step: Confirmation
                showAnalysisConfirmationDialog();
            }
        }
        
        /**
         * Show final confirmation dialog before starting analysis
         */
        function showAnalysisConfirmationDialog() {
            const modal = document.createElement('div');
            modal.className = 'popup-modal';
            
            const selections = analysisWorkflowState.selections;
            const dateRange = selections.date_range || {};
            const vesselTypes = selections.vessel_types || [];
            const anomalyTypes = selections.anomaly_types || [];
            const outputFormats = selections.output_formats || [];
            
            modal.innerHTML = `
                <div class="popup-content">
                    <div class="popup-header">
                        <h2>‚úÖ Confirm Analysis Settings</h2>
                        <p>Review your selections and start the analysis</p>
                    </div>
                    <div class="popup-body" style="max-height: 400px; overflow-y: auto;">
                        <div style="margin-bottom: 15px;">
                            <strong>üìÖ Date Range:</strong><br/>
                            ${dateRange.start_date || 'Not selected'} to ${dateRange.end_date || 'Not selected'}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>üö¢ Vessel Types:</strong><br/>
                            ${vesselTypes.length > 0 ? vesselTypes.join(', ') : 'Not selected'}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>‚ö†Ô∏è Anomaly Types:</strong><br/>
                            ${anomalyTypes.length > 0 ? anomalyTypes.join(', ') : 'Not selected'}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>üìä Output Formats:</strong><br/>
                            ${outputFormats.length > 0 ? outputFormats.join(', ') : 'Not selected'}
                        </div>
                    </div>
                    <div class="popup-actions">
                        <button onclick="startAnalysisFromWorkflow(this)" class="btn-primary">üöÄ Start Analysis</button>
                        <button onclick="cancelAnalysisWorkflow(this)" class="btn-secondary">Return to Chat</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        /**
         * Start analysis from workflow selections
         */
        function startAnalysisFromWorkflow(button) {
            const selections = analysisWorkflowState.selections;
            
            // Validate all selections are made
            if (!selections.date_range || !selections.vessel_types || !selections.anomaly_types) {
                alert('Please complete all required selections (date range, vessel types, and anomaly types)');
                return;
            }
            
            // Close confirmation dialog
            closePopup(button);
            
            // Reset workflow state
            analysisWorkflowState.active = false;
            analysisWorkflowState.step = 0;
            
            // Build analysis request message for LLM
            const analysisMessage = `Please run an anomaly analysis with the following parameters:
- Date range: ${selections.date_range.start_date} to ${selections.date_range.end_date}
- Vessel types: ${selections.vessel_types.join(', ')}
- Anomaly types: ${selections.anomaly_types.join(', ')}
${selections.output_formats && selections.output_formats.length > 0 ? `- Output formats: ${selections.output_formats.join(', ')}` : ''}

Your analysis has started. It may take some time, but I will keep you updated on the progress.`;
            
            // Send to LLM via WebSocket
            if (ws && ws.readyState === WebSocket.OPEN) {
                try {
                    // First send the analysis request
                    ws.send(JSON.stringify({ message: analysisMessage }));
                    
                    // Add user message to chat
                    addMessage('user', 'Start analysis with selected parameters');
                    
                    // Add assistant message about analysis starting
                    addMessage('assistant', 'Your analysis has started. It may take some time, but I will keep you updated on the progress.', 'progress');
                    
                    // Set processing state
                    isProcessing = true;
                    updateSendButton();
                } catch (error) {
                    console.error('Failed to send analysis request:', error);
                    showError('Failed to start analysis. Please try again.');
                }
            } else {
                showError('Not connected to server. Please refresh the page.');
            }
        }
        
        /**
         * Cancel analysis workflow
         */
        function cancelAnalysisWorkflow(button) {
            closePopup(button);
            analysisWorkflowState.active = false;
            analysisWorkflowState.step = 0;
            analysisWorkflowState.selections = {
                date_range: null,
                vessel_types: null,
                anomaly_types: null,
                output_formats: null
            };
        }
        
        /**
         * Show date picker dialog
         */
        function showDatePickerDialog(config) {
            const modal = document.createElement('div');
            modal.className = 'popup-modal';
            modal.innerHTML = `
                <div class="popup-content">
                    <div class="popup-header">
                        <h2>üìÖ Select Date Range</h2>
                        <p>${config.message || 'Please select a date range for analysis'}</p>
                    </div>
                    <div class="popup-body">
                        <div class="form-group">
                            <label>Start Date:</label>
                            <input type="date" id="popup-start-date" 
                                   value="${config.default_start || '2021-01-01'}" 
                                   min="${config.min_date || '2021-01-01'}" 
                                   max="${config.max_date || new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label>End Date:</label>
                            <input type="date" id="popup-end-date" 
                                   value="${config.default_end || new Date().toISOString().split('T')[0]}" 
                                   min="${config.min_date || '2021-01-01'}" 
                                   max="${config.max_date || new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="popup-actions">
                            <button onclick="submitDateSelection(this)" class="btn-primary">Confirm</button>
                            <button onclick="closePopup(this)" class="btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        /**
         * Show vessel type picker dialog
         * Displays all 58 AIS vessel types grouped by 8 categories
         */
        function showVesselTypePickerDialog(config) {
            const modal = document.createElement('div');
            modal.className = 'popup-modal';
            
            // Build HTML from vessel_types_by_category structure
            let optionsHtml = '';
            
            if (config.vessel_types_by_category) {
                // New format: grouped by category
                config.vessel_types_by_category.forEach(category => {
                    optionsHtml += `
                        <div class="vessel-category">
                            <h3 class="category-header">${category.category} (${category.code_range}) - ${category.count} types</h3>
                            <div class="category-types">
                    `;
                    
                    category.types.forEach(type => {
                        const isChecked = config.default_types.includes(category.category) || 
                                         config.default_types.includes(type.name) ||
                                         config.default_types.includes(String(type.code));
                        optionsHtml += `
                            <label class="checkbox-label vessel-type-option">
                                <input type="checkbox" value="${type.code}" 
                                       data-name="${type.name}"
                                       ${isChecked ? 'checked' : ''}>
                                <span class="checkbox-text">
                                    <strong>${type.code}: ${type.name}</strong>
                                    ${type.description ? `<small>${type.description}</small>` : ''}
                                </span>
                            </label>
                        `;
                    });
                    
                    optionsHtml += `
                            </div>
                        </div>
                    `;
                });
            } else if (config.options) {
                // Legacy format: flat list
                optionsHtml = config.options.map(opt => `
                    <label class="checkbox-label">
                        <input type="checkbox" value="${opt.value}" 
                               ${config.default_types.includes(opt.value) ? 'checked' : ''}>
                        <span class="checkbox-text">
                            <strong>${opt.label}</strong>
                            <small>${opt.description}</small>
                        </span>
                    </label>
                `).join('');
            }
            
            modal.innerHTML = `
                <div class="popup-content vessel-type-popup">
                    <div class="popup-header">
                        <h2>üö¢ Select Vessel Types</h2>
                        <p>${config.message || 'Please select vessel types to analyze'}</p>
                        ${config.instructions ? `<p class="instructions">${config.instructions}</p>` : ''}
                    </div>
                    <div class="popup-body scrollable">
                        <div class="checkbox-group">
                            ${optionsHtml}
                        </div>
                        <div class="popup-actions">
                            <button onclick="submitVesselTypeSelection(this)" class="btn-primary">Confirm</button>
                            <button onclick="closePopup(this)" class="btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        /**
         * Show anomaly type picker dialog
         */
        function showAnomalyPickerDialog(config) {
            const modal = document.createElement('div');
            modal.className = 'popup-modal';
            const optionsHtml = config.options.map(opt => `
                <label class="checkbox-label">
                    <input type="checkbox" value="${opt.value}" 
                           ${config.default_types.includes(opt.value) ? 'checked' : ''}>
                    <span class="checkbox-text">
                        <strong>${opt.label}</strong>
                        <small>${opt.description}</small>
                    </span>
                </label>
            `).join('');
            
            modal.innerHTML = `
                <div class="popup-content">
                    <div class="popup-header">
                        <h2>‚ö†Ô∏è Select Anomaly Types</h2>
                        <p>${config.message || 'Please select anomaly types to detect'}</p>
                    </div>
                    <div class="popup-body">
                        <div class="checkbox-group">
                            ${optionsHtml}
                        </div>
                        <div class="popup-actions">
                            <button onclick="submitAnomalySelection(this)" class="btn-primary">Confirm</button>
                            <button onclick="closePopup(this)" class="btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        /**
         * Show output format picker dialog
         */
        function showOutputPickerDialog(config) {
            const modal = document.createElement('div');
            modal.className = 'popup-modal';
            const optionsHtml = config.options.map(opt => `
                <label class="checkbox-label">
                    <input type="checkbox" value="${opt.value}" 
                           ${config.default_outputs.includes(opt.value) ? 'checked' : ''}>
                    <span class="checkbox-text">
                        <strong>${opt.label}</strong>
                        <small>${opt.description}</small>
                    </span>
                </label>
            `).join('');
            
            modal.innerHTML = `
                <div class="popup-content">
                    <div class="popup-header">
                        <h2>üìä Select Output Formats</h2>
                        <p>${config.message || 'Please select output formats'}</p>
                    </div>
                    <div class="popup-body">
                        <div class="checkbox-group">
                            ${optionsHtml}
                        </div>
                        <div class="popup-actions">
                            <button onclick="submitOutputSelection(this)" class="btn-primary">Confirm</button>
                            <button onclick="closePopup(this)" class="btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        /**
         * Submit date selection
         */
        function submitDateSelection(button) {
            const modal = button.closest('.popup-modal');
            const startDate = document.getElementById('popup-start-date').value;
            const endDate = document.getElementById('popup-end-date').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            // Store selection if in workflow
            if (analysisWorkflowState.active) {
                analysisWorkflowState.selections.date_range = {
                    start_date: startDate,
                    end_date: endDate
                };
                closePopup(button);
                // Continue to next step with a small delay to ensure popup closes
                setTimeout(() => {
                    continueAnalysisWorkflow();
                }, 100);
                return;
            }
            
            // Legacy behavior: Send selection back to LLM via WebSocket
            if (ws && ws.readyState === WebSocket.OPEN) {
                try {
                    ws.send(JSON.stringify({
                        type: 'user_selection',
                        selection_type: 'date_range',
                        start_date: startDate,
                        end_date: endDate
                    }));
                } catch (error) {
                    console.error('Failed to send date selection:', error);
                    showError('Failed to send selection. Please try again.');
                    return;
                }
            } else {
                showError('Not connected to server. Please refresh the page.');
                return;
            }
            
            addMessage('user', `Selected date range: ${startDate} to ${endDate}`);
            closePopup(button);
        }
        
        /**
         * Submit vessel type selection
         */
        function submitVesselTypeSelection(button) {
            const modal = button.closest('.popup-modal');
            const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
            
            // Collect selected types, grouping by category
            const selectedByCategory = {};
            const selectedTypes = [];
            
            Array.from(checkboxes).forEach(cb => {
                const code = parseInt(cb.value);
                if (!isNaN(code)) {
                    // Map code to category
                    let category = null;
                    if (code >= 70 && code <= 79) category = 'Cargo';
                    else if (code >= 80 && code <= 89) category = 'Tanker';
                    else if (code >= 30 && code <= 39) category = 'Fishing';
                    else if (code >= 60 && code <= 69) category = 'Passenger';
                    else if (code >= 40 && code <= 49) category = 'HSC';
                    else if (code >= 50 && code <= 59) category = 'Special Purpose';
                    else if (code >= 20 && code <= 29) category = 'WIG';
                    else if (code >= 90 && code <= 99) category = 'Other';
                    
                    if (category) {
                        if (!selectedByCategory[category]) {
                            selectedByCategory[category] = true;
                            selectedTypes.push(category);
                        }
                    } else {
                        // Fallback: use value as-is
                        selectedTypes.push(cb.value);
                    }
                } else {
                    // Not a code, use value directly
                    selectedTypes.push(cb.value);
                }
            });
            
            // Remove duplicates
            const uniqueTypes = [...new Set(selectedTypes)];
            
            if (uniqueTypes.length === 0) {
                alert('Please select at least one vessel type');
                return;
            }
            
            // Store selection if in workflow
            if (analysisWorkflowState.active) {
                analysisWorkflowState.selections.vessel_types = uniqueTypes;
                closePopup(button);
                // Continue to next step with a small delay to ensure popup closes
                setTimeout(() => {
                    continueAnalysisWorkflow();
                }, 100);
                return;
            }
            
            // Legacy behavior: Send selection back to LLM via WebSocket
            if (ws && ws.readyState === WebSocket.OPEN) {
                try {
                    ws.send(JSON.stringify({
                        type: 'user_selection',
                        selection_type: 'vessel_types',
                        vessel_types: uniqueTypes
                    }));
                } catch (error) {
                    console.error('Failed to send vessel type selection:', error);
                    showError('Failed to send selection. Please try again.');
                    return;
                }
            } else {
                showError('Not connected to server. Please refresh the page.');
                return;
            }
            
            addMessage('user', `Selected vessel types: ${uniqueTypes.join(', ')}`);
            closePopup(button);
        }
        
        /**
         * Submit anomaly selection
         */
        function submitAnomalySelection(button) {
            const modal = button.closest('.popup-modal');
            const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
            const selected = Array.from(checkboxes).map(cb => cb.value);
            
            if (selected.length === 0) {
                alert('Please select at least one anomaly type');
                return;
            }
            
            // Store selection if in workflow
            if (analysisWorkflowState.active) {
                analysisWorkflowState.selections.anomaly_types = selected;
                closePopup(button);
                // Continue to next step with a small delay to ensure popup closes
                setTimeout(() => {
                    continueAnalysisWorkflow();
                }, 100);
                return;
            }
            
            // Legacy behavior: Send selection back to LLM via WebSocket
            if (ws && ws.readyState === WebSocket.OPEN) {
                try {
                    ws.send(JSON.stringify({
                        type: 'user_selection',
                        selection_type: 'anomaly_types',
                        anomaly_types: selected
                    }));
                } catch (error) {
                    console.error('Failed to send anomaly selection:', error);
                    showError('Failed to send selection. Please try again.');
                    return;
                }
            } else {
                showError('Not connected to server. Please refresh the page.');
                return;
            }
            
            addMessage('user', `Selected anomaly types: ${selected.join(', ')}`);
            closePopup(button);
        }
        
        /**
         * Submit output selection
         */
        function submitOutputSelection(button) {
            const modal = button.closest('.popup-modal');
            const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
            const selected = Array.from(checkboxes).map(cb => cb.value);
            
            // Output formats are optional, so we don't require at least one
            
            // Store selection if in workflow
            if (analysisWorkflowState.active) {
                analysisWorkflowState.selections.output_formats = selected;
                closePopup(button);
                // Continue to next step (confirmation) with a small delay to ensure popup closes
                setTimeout(() => {
                    continueAnalysisWorkflow();
                }, 100);
                return;
            }
            
            // Legacy behavior: Send selection back to LLM via WebSocket
            if (ws && ws.readyState === WebSocket.OPEN) {
                try {
                    ws.send(JSON.stringify({
                        type: 'user_selection',
                        selection_type: 'output_formats',
                        output_formats: selected
                    }));
                } catch (error) {
                    console.error('Failed to send output selection:', error);
                    showError('Failed to send selection. Please try again.');
                    return;
                }
            } else {
                showError('Not connected to server. Please refresh the page.');
                return;
            }
            
            addMessage('user', `Selected outputs: ${selected.join(', ')}`);
            closePopup(button);
        }
        
        /**
         * Close popup
         */
        function closePopup(button) {
            const modal = button.closest('.popup-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        /**
         * Send message
         */
        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message || isProcessing) return;
            
            // Check WebSocket connection state
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                const state = ws ? ws.readyState : 'null';
                showError(`Not connected to server (state: ${state}). Please refresh the page or wait for connection.`);
                addMessage('assistant', '‚ö†Ô∏è Connection not available. Please check if the backend server is running on port 8000.', 'error');
                // Try to reconnect if ws exists but isn't open
                if (ws && ws.readyState === WebSocket.CONNECTING) {
                    // Already connecting, wait a bit
                    console.log('WebSocket is connecting, waiting...');
                } else if (!ws || ws.readyState === WebSocket.CLOSED || ws.readyState === WebSocket.CLOSING) {
                    // Try to reconnect
                    console.log('Attempting to reconnect WebSocket...');
                    connectWebSocket();
                }
                return;
            }
            
            // Note: Let the LLM handle analysis workflow triggering based on keywords
            // The LLM will recognize keywords like "analysis", "analyze", "look at" and trigger the workflow
            // We no longer intercept here - let the LLM process the message and trigger popups via tools
            
            try {
                // Add user message
                addMessage('user', message);
                
                // Send to backend - LLM will detect analysis intent and trigger workflow
                ws.send(JSON.stringify({ message: message }));
                
                // Clear input
                input.value = '';
                
                // Set processing state
                isProcessing = true;
                updateSendButton();
            } catch (error) {
                console.error('Failed to send message:', error);
                showError('Failed to send message. Please try again.');
                isProcessing = false;
                updateSendButton();
            }
        }
        
        /**
         * Add message to chat
         */
        function addMessage(role, content, messageType = 'normal') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            
            if (messageType === 'progress') {
                // Progress messages have different styling
                messageDiv.className = 'message progress';
                messageDiv.style.cssText = 'background-color: #e3f2fd; border-left: 4px solid #2196f3; padding: 10px; margin: 5px 0; font-style: italic;';
            } else {
                messageDiv.className = `message ${role}`;
            }
            
            const header = document.createElement('div');
            header.className = 'message-header';
            if (messageType === 'progress') {
                header.textContent = '‚è≥ Processing...';
                header.style.cssText = 'font-weight: 600; color: #1976d2;';
            } else {
                header.textContent = role === 'user' ? 'You' : 'AI Assistant';
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            messageDiv.appendChild(header);
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        /**
         * Show error
         */
        function showError(message) {
            const messagesDiv = document.getElementById('messages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            messagesDiv.appendChild(errorDiv);
        }
        
        /**
         * Update send button state
         */
        function updateSendButton() {
            const button = document.getElementById('send-button');
            button.disabled = isProcessing;
            button.textContent = isProcessing ? 'Processing...' : 'Send';
        }
        
        // ============================================================
        // MANUAL ANALYSIS MODAL AND MAP
        // ============================================================
        
        // Global map variable (shared between manual and LLM analysis)
        let mainMap = null;
        let manualAnalysisMap = null; // Leaflet map instance (will be shared with main map)
        
        function showManualAnalysisModal() {
            const modal = document.getElementById('manual-analysis-modal');
            if (!modal) {
                console.error('Manual analysis modal not found');
                return;
            }
            
            modal.style.display = 'flex';
            
            // Set default dates
            const today = new Date();
            const oneMonthAgo = new Date(today);
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            
            const startDateInput = document.getElementById('manual-start-date');
            const endDateInput = document.getElementById('manual-end-date');
            
            if (startDateInput) {
                startDateInput.value = oneMonthAgo.toISOString().split('T')[0];
            }
            if (endDateInput) {
                endDateInput.value = today.toISOString().split('T')[0];
            }
            
            // Populate vessel types
            populateManualVesselTypes();
            
            // Populate anomaly types
            populateManualAnomalyTypes();
            
            // Populate output formats
            populateManualOutputFormats();
        }
        
        function closeManualAnalysisModal() {
            const modal = document.getElementById('manual-analysis-modal');
            if (!modal) {
                console.warn('Manual analysis modal not found');
                return;
            }
            
            // Add closing animation
            const content = modal.querySelector('.modal-content');
            if (content) {
                content.style.animation = 'slideOutToLeft 0.3s ease-in';
                setTimeout(() => {
                    modal.style.display = 'none';
                    content.style.animation = ''; // Reset animation
                }, 300);
            } else {
                modal.style.display = 'none';
            }
        }
        
        function populateManualVesselTypes() {
            const container = document.getElementById('manual-vessel-types');
            const categories = ['Cargo', 'Tanker', 'Fishing', 'Passenger', 'Special Purpose', 'HSC', 'WIG', 'Other'];
            
            container.innerHTML = '';
            categories.forEach(category => {
                const div = document.createElement('div');
                div.style.marginBottom = '5px';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `vessel-${category}`;
                checkbox.value = category;
                checkbox.checked = category === 'Cargo'; // Default to Cargo
                const label = document.createElement('label');
                label.htmlFor = `vessel-${category}`;
                label.textContent = category;
                label.style.marginLeft = '5px';
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }
        
        function populateManualAnomalyTypes() {
            const container = document.getElementById('manual-anomaly-types');
            const types = [
                {value: 'ais_beacon_on', label: 'AIS Beacon On'},
                {value: 'ais_beacon_off', label: 'AIS Beacon Off'},
                {value: 'excessive_travel_distance_fast', label: 'Speed Anomalies'},
                {value: 'cog-heading_inconsistency', label: 'COG/Heading Inconsistency'},
                {value: 'loitering', label: 'Loitering'}
            ];
            
            container.innerHTML = '';
            types.forEach(type => {
                const div = document.createElement('div');
                div.style.marginBottom = '5px';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `anomaly-${type.value}`;
                checkbox.value = type.value;
                checkbox.checked = true; // Default all selected
                const label = document.createElement('label');
                label.htmlFor = `anomaly-${type.value}`;
                label.textContent = type.label;
                label.style.marginLeft = '5px';
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }
        
        function populateManualOutputFormats() {
            const container = document.getElementById('manual-output-formats');
            const formats = [
                {value: 'consolidated_events_csv', label: 'Consolidated Events CSV'},
                {value: 'event_map', label: 'Event Map (with Heatmap)'},
                {value: 'statistics_csv', label: 'Statistics CSV'},
                {value: 'excel_report', label: 'Excel Report'}
            ];
            
            container.innerHTML = '';
            formats.forEach(format => {
                const div = document.createElement('div');
                div.style.marginBottom = '5px';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `output-${format.value}`;
                checkbox.value = format.value;
                checkbox.checked = format.value === 'consolidated_events_csv' || format.value === 'event_map';
                const label = document.createElement('label');
                label.htmlFor = `output-${format.value}`;
                label.textContent = format.label;
                label.style.marginLeft = '5px';
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }
        
        async function submitManualAnalysis() {
            const statusDiv = document.getElementById('manual-analysis-status');
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#e3f2fd';
            statusDiv.style.color = '#1976d2';
            statusDiv.textContent = '‚è≥ Starting analysis...';
            
            // Collect form data
            const startDate = document.getElementById('manual-start-date').value;
            const endDate = document.getElementById('manual-end-date').value;
            
            const vesselTypes = Array.from(document.querySelectorAll('#manual-vessel-types input:checked'))
                .map(cb => cb.value);
            
            const anomalyTypes = Array.from(document.querySelectorAll('#manual-anomaly-types input:checked'))
                .map(cb => cb.value);
            
            const outputFormats = Array.from(document.querySelectorAll('#manual-output-formats input:checked'))
                .map(cb => cb.value);
            
            // Build the request payload
            const requestPayload = {
                session_id: sessionId,
                start_date: startDate,
                end_date: endDate,
                vessel_types: vesselTypes.length > 0 ? vesselTypes : null,  // Empty array becomes null
                anomaly_types: anomalyTypes.length > 0 ? anomalyTypes : [],  // Keep as empty array if none selected
                mmsi_filter: null,
                geographic_zone: null,
                output_formats: outputFormats  // Include output formats for backend processing
            };
            
            // ============================================================
            // DEBUG: Log exactly what is being sent to the backend
            // ============================================================
            console.log('='.repeat(80));
            console.log('üì§ MANUAL ANALYSIS REQUEST - EXACT PAYLOAD BEING SENT:');
            console.log('='.repeat(80));
            console.log(JSON.stringify(requestPayload, null, 2));
            console.log('\nüìã Payload Details:');
            console.log(`  - session_id: ${requestPayload.session_id} (type: ${typeof requestPayload.session_id})`);
            console.log(`  - start_date: ${requestPayload.start_date} (type: ${typeof requestPayload.start_date})`);
            console.log(`  - end_date: ${requestPayload.end_date} (type: ${typeof requestPayload.end_date})`);
            console.log(`  - vessel_types: ${JSON.stringify(requestPayload.vessel_types)} (type: ${Array.isArray(requestPayload.vessel_types) ? 'array' : typeof requestPayload.vessel_types}, length: ${requestPayload.vessel_types ? requestPayload.vessel_types.length : 'N/A'})`);
            console.log(`  - anomaly_types: ${JSON.stringify(requestPayload.anomaly_types)} (type: ${Array.isArray(requestPayload.anomaly_types) ? 'array' : typeof requestPayload.anomaly_types}, length: ${requestPayload.anomaly_types.length})`);
            console.log(`  - mmsi_filter: ${requestPayload.mmsi_filter} (type: ${typeof requestPayload.mmsi_filter})`);
            console.log(`  - geographic_zone: ${requestPayload.geographic_zone} (type: ${typeof requestPayload.geographic_zone})`);
            console.log(`  - output_formats: ${JSON.stringify(requestPayload.output_formats)} (type: ${Array.isArray(requestPayload.output_formats) ? 'array' : typeof requestPayload.output_formats})`);
            console.log('='.repeat(80));
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/manual-analysis`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestPayload)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.style.background = '#e8f5e9';
                    statusDiv.style.color = '#2e7d32';
                    statusDiv.textContent = `‚úÖ Analysis complete! Found ${result.anomalies_found || 0} anomalies.`;
                    
                    // Mark analysis as completed
                    analysisWorkflowState.analysisCompleted = true;
                    analysisWorkflowState.lastAnalysisId = result.analysis_id;
                    saveAppState();
                    
                    // Update map with generated HTML map (preferred) or anomalies data
                    if (result.files_generated && result.files_generated.length > 0) {
                        // Find the map file
                        const mapFile = result.files_generated.find(f => 
                            f.type === 'map' && (f.name && /all anomalies|event map/i.test(f.name))
                        );
                        if (mapFile && mapFile.path) {
                            loadMapInPanel(mapFile.path);
                        } else if (result.anomalies && result.anomalies.length > 0) {
                            updateMapWithAnomalies(result.anomalies);
                        }
                    } else if (result.anomalies && result.anomalies.length > 0) {
                        updateMapWithAnomalies(result.anomalies);
                    }
                    
                    // Close modal after 2 seconds
                    setTimeout(() => {
                        closeManualAnalysisModal();
                    }, 2000);
                } else {
                    statusDiv.style.background = '#ffebee';
                    statusDiv.style.color = '#c62828';
                    statusDiv.textContent = `‚ùå Error: ${result.error || 'Analysis failed'}`;
                }
            } catch (error) {
                statusDiv.style.background = '#ffebee';
                statusDiv.style.color = '#c62828';
                statusDiv.textContent = `‚ùå Error: ${error.message}`;
            }
        }
        
        // ============================================================
        // MAP INITIALIZATION AND UPDATES
        // ============================================================
        
        function initializeMap() {
            // Hide placeholder
            document.getElementById('map-placeholder').style.display = 'none';
            
            // Initialize Leaflet map
            manualAnalysisMap = L.map('map-container').setView([20, 0], 2);
            
            // Add OpenStreetMap tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(manualAnalysisMap);
        }
        
        async function fetchAnomaliesForMap() {
            if (!sessionId) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/sessions/${sessionId}/anomalies-for-map`);
                const data = await response.json();
                
                if (data.success && data.anomalies && data.anomalies.length > 0) {
                    updateMapWithAnomalies(data.anomalies);
                }
            } catch (error) {
                console.error('Error fetching anomalies for map:', error);
            }
        }
        
        function updateMapWithAnomalies(anomalies) {
            // NOTE: This function is kept for backward compatibility
            // But the preferred method is to load the generated HTML map via loadMapInPanel()
            // which contains all features (clustering, heatmap, grouping, etc.)
            console.log('updateMapWithAnomalies called - but should use generated map instead');
            
            // If we have a generated map path, use that instead
            if (appState.lastMapPath) {
                loadMapInPanel(appState.lastMapPath);
                return;
            }
            
            // Fallback: Use simple markers if no generated map available
            const mapToUpdate = mainMap || manualAnalysisMap;
            if (!mapToUpdate) {
                initializeMap();
                mainMap = manualAnalysisMap;
            }
            
            const map = mainMap || manualAnalysisMap;
            
            // Clear existing markers (but keep tile layer)
            map.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.CircleMarker || layer instanceof L.Circle) {
                    map.removeLayer(layer);
                }
            });
            
            if (!anomalies || anomalies.length === 0) {
                return;
            }
            
            // Add markers for each anomaly (simplified version)
            const bounds = [];
            const markerGroup = L.layerGroup();
            
            anomalies.forEach(anomaly => {
                const lat = parseFloat(anomaly.LAT || anomaly.lat);
                const lon = parseFloat(anomaly.LON || anomaly.lon);
                
                if (!isNaN(lat) && !isNaN(lon) && lat !== 0 && lon !== 0) {
                    let color = '#ff4444';
                    if (anomaly.AnomalyType || anomaly.type) {
                        const type = (anomaly.AnomalyType || anomaly.type).toLowerCase();
                        if (type.includes('beacon')) color = '#ff8800';
                        else if (type.includes('speed') || type.includes('travel')) color = '#ff0000';
                        else if (type.includes('cog') || type.includes('heading')) color = '#8800ff';
                        else if (type.includes('loiter')) color = '#00ff88';
                    }
                    
                    const marker = L.circleMarker([lat, lon], {
                        radius: 6,
                        fillColor: color,
                        color: '#000000',
                        weight: 1,
                        opacity: 0.9,
                        fillOpacity: 0.7
                    });
                    
                    const popupContent = `
                        <strong>Anomaly Details</strong><br>
                        MMSI: ${anomaly.MMSI || anomaly.mmsi || 'N/A'}<br>
                        Type: ${anomaly.AnomalyType || anomaly.type || 'N/A'}<br>
                        Date: ${anomaly.BaseDateTime || anomaly.datetime || 'N/A'}<br>
                        Vessel Type: ${anomaly.VesselType || anomaly.vessel_type || 'N/A'}
                    `;
                    marker.bindPopup(popupContent);
                    
                    markerGroup.addLayer(marker);
                    bounds.push([lat, lon]);
                }
            });
            
            markerGroup.addTo(map);
            if (bounds.length > 0) {
                map.fitBounds(bounds, {padding: [50, 50]});
            }
        }
        
        // Initialize map on page load (only if no generated map to load)
        document.addEventListener('DOMContentLoaded', () => {
            // Wait a bit for page to fully load
            setTimeout(() => {
                // Only initialize simple map if we don't have a generated map to load
                if (!appState.lastMapPath && !mainMap && !manualAnalysisMap) {
                    initializeMap();
                    mainMap = manualAnalysisMap; // Store reference
                    appState.mapInitialized = true;
                    saveAppState();
                }
            }, 500);
        });
    </script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>

